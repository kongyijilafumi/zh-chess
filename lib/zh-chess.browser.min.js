var ZhChess=function(e){"use strict";var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},t(e,i)};function i(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}var r=function(){return r=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},r.apply(this,arguments)},n=function(){function e(e,t){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.x=e,this.y=t}return Object.defineProperty(e.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"(".concat(this.x,",").concat(this.y,")")}}),e}(),o=function(e){function t(t,i,r){var o=e.call(this,t,i)||this;return Object.defineProperty(o,"disPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),o.disPoint=new n(r.x,r.y),o}return i(t,e),Object.defineProperty(t.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=!(10===this.disPoint.x&&10===this.disPoint.y);return"(".concat(this.x,",").concat(this.y,")").concat(e?"<阻碍点"+this.disPoint+">":"")}}),t}(n),a={x:10,y:10},s=function(){function e(e){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"side",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isChoose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.x=e.x,this.y=e.y,this.name=e.name,this.side=e.side,this.isChoose=e.isChoose||!1}return Object.defineProperty(e.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"[".concat(this.side,"方]:").concat(this.name,"(").concat(this.x,",").concat(this.y,")")}}),Object.defineProperty(e.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return e.filter((function(e){var r=t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===i.side}));return e.x>=0&&e.x<=8&&e.y>=0&&e.y<=9&&!r}))}}),Object.defineProperty(e.prototype,"getCurrentInfo",{enumerable:!1,configurable:!0,writable:!0,value:function(){return{side:this.side,name:this.name,x:this.x,y:this.y}}}),Object.defineProperty(e.prototype,"update",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.x=e.x,this.y=e.y}}),Object.defineProperty(e.prototype,"draw",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,r,n,o,a,s,c,u){var l=this.isChoose?"red":"#000",h=t+Math.abs(this.x-o)*r,f=i+Math.abs(this.y-a)*n,v=s,b=0;e.fillStyle=u;var d=function(t,i,r,n,o){e.beginPath(),e.arc(t,i,r,n,o),e.closePath(),e.stroke()};this.isChoose&&(v/=.98,b="RED"===this.side?-.3*s:.3*s,b=a>0?-1*b:b),e.beginPath(),e.arc(h,f+b,v,0,2*Math.PI),e.shadowOffsetX=3,e.shadowOffsetY=4,e.shadowColor="#333",e.shadowBlur=5,e.fill(),e.closePath(),e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.strokeStyle=l,d(h,f+b,v,0,2*Math.PI),d(h,f+b,v-3,0,2*Math.PI),e.textAlign="center",e.textBaseline="middle",e.fillStyle=c,e.font=s+"px yahei",e.fillText(this.name,h,f+b)}}),Object.defineProperty(e.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return[]}}),Object.defineProperty(e.prototype,"drawMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,r,n,o,a,s,c){e.fillStyle="#25dd2a",this.getMovePoints(t).forEach((function(t){var u=i+Math.abs(t.x-a)*n,l=r+Math.abs(t.y-s)*o;e.beginPath(),e.arc(u,l,.25*c,0,2*Math.PI),e.closePath(),e.fill()}))}}),e}(),c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMoveObstaclePieceList",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this,r=this.x===e.x?"y":"x",n="x"===r?"y":"x",o=this[r]-e[r],a=o>0?e[r]:this[r],s=o<0?e[r]:this[r];return t.filter((function(t){var o=!(i.x===t.x&&i.y===t.y),c=t[n]===e[n],u=t[r]>a&&t[r]<s,l=t.side===i.side,h=t[r]>=a&&t[r]<=s;return c&&o&&u||c&&o&&l&&h}))}}),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(e.x<0||e.x>8||e.y<0||e.y>9)return{flag:!1,message:"移动位置不符合规则"};if(this.y===e.y||this.x===e.x){var i=this.getMoveObstaclePieceList(e,t);return i.length>0?{flag:!1,message:"移动距离中存在障碍物："+i.join("---")}:{flag:!0}}return{flag:!1,message:"移动位置不符合规则"}}}),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=Array.from({length:9},(function(e,i){return new o(i,t.y,a)})),r=Array.from({length:10},(function(e,i){return new o(t.x,i,a)})),n=i.concat(r).filter((function(e){return!(t.x===e.x&&t.y===e.y)}));return e?n.filter((function(i){return!0===t.move(i,e).flag})):n}}),t}(s),u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],i=0;i<2;i++){var r=this.x-2,n=2*i+(this.y-1);t.push(new o(r,n,{x:this.x-1,y:this.y}));var a=this.x+2,s=n;t.push(new o(a,s,{x:this.x+1,y:this.y}));var c=2*i+(this.x-1),u=this.y-2;t.push(new o(c,u,{x:this.x,y:this.y-1}));var l=c,h=this.y+2;t.push(new o(l,h,{x:this.x,y:this.y+1}))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(t,i){return e.prototype.filterMovePoints.call(this,t,i).filter((function(e){return!Boolean(function(e,t){return e.find((function(e){return e.x===t.x&&e.y===t.y}))}(i,e.disPoint))}))}}),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this.getMovePoints(t).find((function(t){return e.x===t.x&&e.y===t.y}));if(!i)return{flag:!1,message:"".concat(this,"走法错误，不可以落在").concat(e,"上")};var r=t.find((function(e){return e.x===i.disPoint.x&&e.y===i.disPoint.y}));return r?{flag:!1,message:"".concat(this,"走法错误，").concat(r,"卡住了").concat(this.name,"的去向")}:{flag:!0}}}),t}(s),l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],i=0;i<2;i++){var r=this.x-2+4*i,n=this.y-2,a=this.x-1+2*i,s=this.y-1;t.push(new o(r,n,{x:a,y:s}));var c=this.x-2+4*i,u=this.y+2,l=a,h=this.y+1;t.push(new o(c,u,{x:l,y:h}))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return e.filter((function(e){return!t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===i.side}))&&e.x>=0&&e.x<=8&&e.y>=0&&e.y<=9&&("RED"===i.side&&e.y>=5||"BLACK"===i.side&&e.y<=4)}))}}),t}(u),h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],i=0;i<2;i++){var r=this.x-1+2*i,n=this.y-1;t.push(new o(r,n,a));var s=this.x-1+2*i,c=this.y+1;t.push(new o(s,c,a))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return e.filter((function(e){return!t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===i.side}))&&e.x<=5&&e.x>=3&&("RED"===i.side&&e.y>=7&&e.y<=9||"BLACK"===i.side&&e.y>=0&&e.y<=2)}))}}),t}(l),f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=[new o(this.x-1,this.y,a),new o(this.x+1,this.y,a),new o(this.x,this.y-1,a),new o(this.x,this.y+1,a)];return this.filterMovePoints(t,e)}}),t}(h),v=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(e.x<0||e.x>8||e.y<0||e.y>9)return{flag:!1,message:"移动位置不符合规则"};if(this.y===e.y||this.x===e.x){var i=this.getMoveObstaclePieceList(e,t);if(i.length>1)return{flag:!1,message:"移动距离存在多个炮架："+i.join("---")};if(1===i.length&&i[0].x===e.x&&i[0].y===e.y)return{flag:!1,message:"无法击中敌方棋子(缺少炮架)，移动无效"};if(1===i.length)return t.find((function(t){return t.x===e.x&&t.y===e.y}))?{flag:!0}:{flag:!1,message:"无法击中敌方棋子，移动无效"};var r=t.find((function(t){return t.x===e.x&&t.y===e.y}));return 0===i.length&&r?{flag:!1,message:"无法击中敌方棋子(缺少炮架)，移动无效"}:{flag:!0}}return{flag:!1,message:"移动位置不符合规则"}}}),t}(c),b=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t="RED"===this.side?this.y<=4:this.y>=5,i="RED"===this.side?-1:1,r=new o(this.x,this.y+i,a),n=t?[r,new o(this.x-1,this.y,a),new o(this.x+1,this.y,a)]:[r];return this.filterMovePoints(n,e)}}),t}(u),d={"仕":function(e){return new h(e)},"兵":function(e){return new b(e)},"卒":function(e){return new b(e)},"士":function(e){return new h(e)},"将":function(e){return new f(e)},"帅":function(e){return new f(e)},"炮":function(e){return new v(e)},"相":function(e){return new l(e)},"砲":function(e){return new v(e)},"象":function(e){return new l(e)},"車":function(e){return new c(e)},"车":function(e){return new c(e)},"馬":function(e){return new u(e)},"马":function(e){return new u(e)}},g=["前","中","后"],y=["进","平","退"],m="(".concat(y.join("|"),")"),P=["1","2","3","4","5","6","7","8","9"].concat(["一","二","三","四","五","六","七","八","九"]),p="(".concat(P.join("|"),")"),w="(".concat(Object.keys(d).join("|"),")"),x=new RegExp("(".concat(g.concat(P).join("|"),")").concat(w).concat(m).concat(p,"$")),E=new RegExp("".concat(w).concat(p).concat(m).concat(p,"$")),O=new RegExp("(".concat(g.join("|"),")").concat(p).concat(m).concat(p,"$")),S=function(e,t,i){var r,o,a,s=i.filter((function(e){return e.side===t})),c="RED"===t,u="BLACK"===t?8:0,l="BLACK"===t?9:0,h=c?1:-1;if(O.test(e)&&(o=O.exec(e))){var f=Math.abs(C(o[2])-1-u),v=o[3],b=C(o[4]),d=j("兵",t);if("平"===v&&(b-=1),(w=s.filter((function(e){return e.x===f&&e.name===d}))).length<2)return!1;w.sort((function(e,t){return c?e.y-t.y:t.y-e.y}));var m=w[3===w.length?C(o[1])-1:"前"===o[1]?0:1],P=Math.abs(m.y-l),p=c?P-b*h:P+b*h;if(v===y[0])return{mp:new n(m.x,p),choose:m};if(v===y[1])return{mp:new n(Math.abs(b-u),P),choose:m}}if(x.test(e)&&(r=x.exec(e))){x.lastIndex=0;var w,S=j(r[2],t);v=r[3],b=C(r[4]);if("平"===v&&(b-=1),(w=s.filter((function(e){return e.name===S}))).length<2)return!1;var M,L=0,A={};w.forEach((function(e){A[e.x]?A[e.x]+=1:A[e.x]=1}));for(var k=Object.keys(A),T=0;T<k.length;T++){var B=A[k[T]];if(L<B)L=B;else if(L===B)return!1}if(M=k[0],(L=A[M])<2)return!1;var R=w.filter((function(e){return String(e.x)===M})),D=r[1];if(D===g[1]&&3!==L)return!1;if(L>=3){R.sort((function(e,t){return c?e.y-t.y:t.y-e.y}));m=R[C(D)-1],P=Math.abs(m.y-l),p=c?P-b*h:P+b*h;if(v===y[0])return{mp:new n(m.x,p),choose:m};if(v===y[1])return{mp:new n(Math.abs(b-u),P),choose:m}}if(2===L&&g.filter((function(e){return"中"!==e})).includes(D)){P=(m=R[D===g[0]?0:1]).y;var K=(N=m.x)-b;if(v===y[0]||v===y[2]){var G=Math.abs(K),I=v===y[2]?-1:1;if("马"===S||"馬"===S){if(G>=1&&G<=2){var F=1==G;return{choose:m,mp:new n($=K<0?F?N-1*h:N-2*h:F?N+1*h:N+2*h,F?P-2*h*I:P-1*h*I)}}return!1}var X=["仕","士"];if((z=["相","象"].includes(S))||X.includes(S)){var Y=z?2:1;return(!z||3===G)&&(!(!z&&1!==G)&&{choose:m,mp:new n($=K>0?N+Y*h:N-Y*h,P-Y*h*I)})}return{choose:m,mp:new n(N,p=P-b*h*I)}}if(v===y[1])return{choose:m,mp:new n(Math.abs(b-u),P)}}return!1}if(E.test(e)&&(a=E.exec(e))){var H=j(a[1],t),_=C(a[2])-1;v=a[3],b=C(a[4]);"平"===v&&(b-=1);var W=Math.abs(_-u);if(!(m=s.filter((function(e){return e.x===W&&e.name===H}))).length)return!1;if(m.length>=2)return!1;P=m[0].y;var N=m[0].x;K=Math.abs(N-u)-b,G=Math.abs(K);if(v===y[0]||v===y[2]){I=v===y[2]?-1:1;if("马"===H||"馬"===H){var V=Math.abs(Math.abs(N-u)-(b-1));if(V>=1&&V<=2){var q=(F=1===V)?P-2*h*I:P-1*h*I,$=K+1<0?F?N+1*h:N+2*h:F?N-1*h:N-2*h;return{choose:m[0],mp:new n($,q)}}return!1}var z;X=["仕","士"];if((z=["相","象"].includes(H))||X.includes(H)){Y=z?2:1;if(z&&3!==G)return!1;if(!z&&1!==G)return!1;$=K>0?N+Y*h:N-Y*h;var U=P-Y*h*I;return{choose:m[0],mp:new n($,U)}}p=P-b*h*I;return{choose:m[0],mp:new n(N,p)}}if(v===y[1])return{choose:m[0],mp:new n(Math.abs(b-u),P)}}return!1};function j(e,t){switch(e){case"车":case"車":return"BLACK"===t?"車":"车";case"兵":case"卒":return"BLACK"===t?"卒":"兵";case"仕":case"士":return"BLACK"===t?"仕":"士";case"将":case"帅":return"BLACK"===t?"将":"帅";case"炮":case"砲":return"BLACK"===t?"砲":"炮";case"相":case"象":return"BLACK"===t?"象":"相";case"馬":case"马":return"BLACK"===t?"馬":"马";default:return null}}function C(e){switch(e){case"1":case"一":case"前":return 1;case"2":case"二":case"中":return 2;case"3":case"三":case"后":return 3;case"4":case"四":return 4;case"5":case"五":return 5;case"6":case"六":return 6;case"7":case"七":return 7;case"8":case"八":return 8;case"9":case"九":return 9;default:return 10}}function M(e){switch(e){case"K":return"帅";case"k":return"将";case"A":return"士";case"a":return"仕";case"B":return"相";case"b":return"象";case"N":return"马";case"n":return"馬";case"R":return"车";case"r":return"車";case"C":return"炮";case"c":return"砲";case"P":return"兵";case"p":return"卒";default:return null}}function L(e){switch(e){case"将":case"帅":return"k";case"仕":case"士":return"a";case"象":case"相":return"b";case"馬":case"马":return"n";case"車":case"车":return"r";case"砲":case"炮":return"c";case"卒":case"兵":return"p";default:return null}}function A(e,t){var i=Array.from({length:10},(function(){return[]}));e.forEach((function(e){var t=e.getCurrentInfo(),r=t.y;i[r].push(t)})),i=i.map((function(e){return e=e.sort((function(e,t){return t.x-e.x}))}));for(var r="",n=0;n<i.length;n++){var o=i[n],a=o.length,s=8;0===a&&(r+="9");for(var c=0;c<a;c++,s--){var u=o[c],l="RED"===u.side,h=L(u.name);if(!h)throw new Error("未找到 ".concat(u.name,' 对应的 PEN 代码，请检查棋子名称是否符合正确格式:\n例如： 车 "车","車"...'));var f=(c>0?o[c-1].x-1:s)-u.x;if(f>0&&(r+=String(f)),r+=l?h.toUpperCase():h,c+1===a){var v=u.x;v>0&&(r+=String(v))}}n<i.length-1&&(r+="/")}return r+" "+function(e){return"BLACK"===e?"b":"w"}(t)}function k(e,t,i){return[r({},e),{x:t+e.x,y:e.y},{x:t+e.x,y:e.y+i},{x:e.x,y:e.y+i}]}var T=function(e,t){return e.find((function(e){return e.x===t.x&&e.y===t.y}))},B=function(){function e(e){var t=e.ctx,i=e.gameWidth,r=void 0===i?800:i,n=e.gameHeight,o=void 0===n?800:n,a=e.gamePadding,s=void 0===a?20:a,c=e.scaleRatio,u=void 0===c?1:c,l=e.moveSpeed,h=void 0===l?8:l,f=e.redPeiceBackground,v=void 0===f?"#feeca0":f,b=e.blackPeiceBackground,d=void 0===b?"#fdec9e":b,g=e.checkerboardBackground,y=void 0===g?"#faebd7":g;if(Object.defineProperty(this,"currentSide",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"livePieceList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"choosePiece",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridHeight",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"radius",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ctx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridPostionList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"moveSpeed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridDiffX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridDiffY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gameState",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"moveEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"moveFailEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"overEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"redPeiceBackground",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blackPeiceBackground",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkerboardBackground",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"winner",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"gameSide",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"animate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cancelAnimate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!t)throw new Error("请传入画布");this.moveEvents=[],this.moveFailEvents=[],this.logEvents=[],this.overEvents=[],this.ctx=t,this.redPeiceBackground=v,this.blackPeiceBackground=d,this.checkerboardBackground=y,this.ctx.scale(u,u),this.listenClick=this.listenClick.bind(this),this.listenClickAsync=this.listenClickAsync.bind(this),this.gridPostionList=[],this.setGridList(),this.gameState="INIT",this.moveSpeed=h,this.setGameWindow(r,o,s),this.init(),this.animate=globalThis.requestAnimationFrame||globalThis.webkitRequestAnimationFrame||globalThis.mozRequestAnimationFrame||globalThis.oRequestAnimationFrame||globalThis.msRequestAnimationFrame||function(e){return globalThis.setTimeout(e,1e3/60)},this.cancelAnimate=globalThis.cancelAnimationFrame||globalThis.webkitCancelAnimationFrame||globalThis.mozCancelAnimationFrame||globalThis.oCancelAnimationFrame||globalThis.msCancelAnimationFrame||globalThis.clearTimeout}return Object.defineProperty(e.prototype,"setGameWindow",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){for(var r=t-2*i,n=r;n%9!=0;)n++;this.gridWidth=n/9,this.gridHeight=r/10,this.startX=(e-n+this.gridWidth)/2,this.startY=(t-r+this.gridHeight)/2,this.endX=this.startX+8*this.gridWidth,this.endY=this.startY+9*this.gridHeight,this.radius=.45*this.gridHeight,this.width=e,this.height=t}}),Object.defineProperty(e.prototype,"getGridDiff",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){return"BLACK"===e?"x"===t?8:9:0}}),Object.defineProperty(e.prototype,"setGridDiff",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.gridDiffX=this.getGridDiff(e,"x"),this.gridDiffY=this.getGridDiff(e,"y")}}),Object.defineProperty(e.prototype,"setGridList",{enumerable:!1,configurable:!0,writable:!0,value:function(){for(var e=0;e<9;e++)for(var t=0;t<10;t++)this.gridPostionList.push(new n(e,t))}}),Object.defineProperty(e.prototype,"getGridPosition",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;return this.gridPostionList.find((function(i){var r=Math.abs(i.x-t.gridDiffX)*t.gridWidth+t.startX,n=Math.abs(i.y-t.gridDiffY)*t.gridHeight+t.startY;return Math.sqrt(Math.pow(r-e.x,2)+Math.pow(n-e.y,2))<t.radius}))}}),Object.defineProperty(e.prototype,"init",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.currentSide="RED",this.choosePiece=null,this.livePieceList=[],this.ctx.clearRect(0,0,this.width,this.height),this.drawChessLine(this.ctx)}}),Object.defineProperty(e.prototype,"initPiece",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.livePieceList=function(){for(var e=[],t=0;t<2;t++){var i=new c({x:0+8*t,y:0,name:"車",side:"BLACK",isChoose:!1}),r=new u({x:1+6*t,y:0,name:"馬",side:"BLACK",isChoose:!1}),n=new l({x:2+4*t,y:0,name:"象",side:"BLACK",isChoose:!1}),o=new h({x:3+2*t,y:0,name:"仕",side:"BLACK",isChoose:!1}),a=new v({x:1+6*t,y:2,name:"砲",side:"BLACK",isChoose:!1}),s=new c({x:0+8*t,y:9,name:"车",side:"RED",isChoose:!1}),d=new u({x:1+6*t,y:9,name:"马",side:"RED",isChoose:!1}),g=new l({x:2+4*t,y:9,name:"相",side:"RED",isChoose:!1}),y=new h({x:3+2*t,y:9,name:"士",side:"RED",isChoose:!1}),m=new v({x:1+6*t,y:7,name:"炮",side:"RED",isChoose:!1});e.push(i,r,n,o,a,s,d,g,y,m)}for(t=0;t<5;t++){var P=new b({x:2*t,y:3,name:"卒",side:"BLACK",isChoose:!1}),p=new b({x:2*t,y:6,name:"兵",side:"RED",isChoose:!1});e.push(P,p)}var w=new f({x:4,y:0,name:"将",side:"BLACK",isChoose:!1}),x=new f({x:4,y:9,name:"帅",side:"RED",isChoose:!1});return e.push(w,x),e}(),this.choosePiece=null,this.redraw()}}),Object.defineProperty(e.prototype,"updateAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,r){var o=this,a=this.update(e,t,i);if(!a.flag||!t)return Promise.resolve(a);var s,c,u=e.x-t.x,l=e.y-t.y,h=e.x,f=e.y,v=u/this.moveSpeed,b=l/this.moveSpeed;return this.clearMoveChoosePeiece(),new Promise((function(i){var a=function(){if(Math.abs(h-t.x)<=Math.abs(v)&&Math.abs(f-t.y)<=Math.abs(b))return o.cancelAnimate.call(globalThis,s),i(null),c&&c.update(e),{flag:!0};var u=new n(h,f);c=T(o.livePieceList,u);var l=new n(h-=v,f-=b);c&&(c.isChoose=!1,c.update(l)),r(),s=o.animate.call(globalThis,a)};a()})).then((function(){return a}))}}),Object.defineProperty(e.prototype,"update",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){var n=this;if(!this.checkGameState())return{flag:!1,message:"当前游戏状态不可以移动棋子"};if(this.currentSide!==i)return{flag:!1,message:"请等待对方下棋"};var o=T(this.livePieceList,e);if(!o)return{flag:!1,message:"未找到棋子"};if(this.currentSide!==o.side)return{flag:!1,message:"选中了敌方的棋子"};if(this.clearMoveChoosePeiece(),o.isChoose=!0,this.choosePiece=o,!t)return this.logEvents.forEach((function(e){return e(i+"方： 选中 "+o)})),{flag:!0,move:!1};var a=T(this.livePieceList,t),s=this.choosePiece.move(t,this.livePieceList),c=function(e){var a="move"in e;if(n.checkGeneralInTrouble(i,o,e,n.livePieceList))return{flag:!1,message:"不可以送将！"};var s="RED"===i?"BLACK":"RED",c=!1,u=n.checkGeneralInTrouble(s,o,e,n.livePieceList);if(u){var l=n.livePieceList.filter((function(e){return!(e.x===o.x&&e.y===o.y)})),h=d[o.name](r(r({},o),t));l.push(h),n.checkEnemySideInTroubleHasSolution(s,l)||(c=!0,n.gameState="OVER",n.winner=i)}else{n.checkEnemySideHasMovePoints(s)||(c=!0,n.gameState="OVER",n.winner=i)}return{flag:!0,move:!0,cb:function(){var s=d[o.name](r(r({},o),t));a||(n.livePieceList=n.livePieceList.filter((function(t){return!(t.x===e.eat.x&&t.y===e.eat.y)}))),o.update(t),n.moveEvents.forEach((function(t){return t(s,e,c||u,n.getCurrentPenCode())})),c&&n.overEvents.forEach((function(e){return e(i)})),o.update(t),n.clearMoveChoosePeiece(),n.changeSide(),n.gameState="START"}}};return a?a.side===i?e.x===t.x&&e.y===t.y?(this.clearMoveChoosePeiece(),this.logEvents.forEach((function(e){return e(i+"方： 取消选中 "+a)})),{flag:!0,move:!1}):(this.choosePiece.isChoose=!1,this.choosePiece=a,this.choosePiece.isChoose=!0,this.logEvents.forEach((function(e){return e("".concat(n.currentSide,"方：切换 选中棋子 由").concat(n.choosePiece," --\x3e ").concat(a))})),{flag:!0,move:!1}):(this.logEvents.forEach((function(e){return e("当前：".concat(n.currentSide," ,棋子:").concat(n.choosePiece," 需要移动到：").concat(t," 这个点上，并且要吃掉 ").concat(a))})),s.flag?c({eat:t}):s):s.flag?c({move:t}):s}}),Object.defineProperty(e.prototype,"draw",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;e.clearRect(0,0,this.width,this.height),this.drawChessLine(e);var i=this,r=i.startX,n=i.startY,o=i.gridWidth,a=i.gridHeight,s=i.gridDiffX,c=i.gridDiffY,u=i.radius;this.livePieceList.forEach((function(i){var l="BLACK"===i.side?"#000":"#c1190c",h="BLACK"===i.side?t.blackPeiceBackground:t.redPeiceBackground;i===t.choosePiece&&i.drawMovePoints(e,t.livePieceList,r,n,o,a,s,c,u),i.draw(e,r,n,o,a,s,c,u,l,h)}))}}),Object.defineProperty(e.prototype,"drawPeice",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;this.ctx.clearRect(0,0,this.width,this.height),this.drawChessLine(this.ctx),e.forEach((function(e){return t.drawSinglePeice(t.ctx,e,!0)}))}}),Object.defineProperty(e.prototype,"drawSinglePeice",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){var r=this,n=r.startX,o=r.startY,a=r.gridWidth,s=r.gridHeight,c=r.gridDiffX,u=r.gridDiffY,l=r.radius,h="BLACK"===t.side?this.blackPeiceBackground:this.redPeiceBackground,f="BLACK"===t.side?"#000":"#c1190c",v=t.isChoose?"red":"#000",b=n+t.x*a,d=o+t.y*s;i&&(b=n+Math.abs(t.x-c)*a,d=o+Math.abs(t.y-u)*s);var g=l,y=0;e.fillStyle=h;var m=function(t,i,r,n,o){e.beginPath(),e.arc(t,i,r,n,o),e.closePath(),e.stroke()};t.isChoose&&(g/=.98,y="RED"===t.side?-3:3,y=u>0?-1*y:y),e.beginPath(),e.arc(b,d+y,g,0,2*Math.PI),e.shadowOffsetX=3,e.shadowOffsetY=4,e.shadowColor="#333",e.shadowBlur=5,e.fill(),e.closePath(),e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.strokeStyle=v,m(b,d+y,g,0,2*Math.PI),m(b,d+y,g-3,0,2*Math.PI),e.textAlign="center",e.textBaseline="middle",e.fillStyle=f,e.font=l+"px yahei",e.fillText(t.name,b,d+y)}}),Object.defineProperty(e.prototype,"drawChessLine",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=t.startX,r=t.startY,n=t.endX,o=t.endY,a=t.gridWidth,s=t.gridHeight;e.fillStyle=this.checkerboardBackground,e.fillRect(0,0,this.width,this.width),e.strokeStyle="#000";for(var c=0;c<10;c++){e.beginPath();var u=r+s*c;e.moveTo(i,u),e.lineTo(n,u),e.closePath(),e.stroke()}for(c=0;c<9;c++){var l=i+c*a,h=r+4*s,f=r+9*s;0!==c&&8!==c?(e.beginPath(),e.moveTo(l,r),e.lineTo(l,h),e.closePath(),e.stroke(),e.beginPath(),e.moveTo(l,h+s),e.lineTo(l,o),e.closePath(),e.stroke()):(e.beginPath(),e.moveTo(l,r),e.lineTo(l,f),e.closePath(),e.stroke())}for(c=0;c<2;c++){var v=k({x:l=i+3*a,y:r+7*s*c},2*a,2*s);e.beginPath(),e.moveTo(v[0].x,v[0].y),e.lineTo(v[2].x,v[2].y),e.moveTo(v[1].x,v[1].y),e.lineTo(v[3].x,v[3].y),e.closePath(),e.stroke()}for(var b=0;b<9;b+=2){for(var d=.15*a,g=.1*a,y=0;y<2;y++)for(var m=0===y?-g:+g,P=0===y?+g:-g,p=0===y?+d:-d,w=0;w<2;w++){u=w%2==0?r+3*s:r+6*s;for(var x=0;x<2;x++){var E=x%2==0?-p:+p;(l=x%2==0?i+b*a+m:i+b*a-m)-i>0&&l-(i+8*a)<0&&(e.beginPath(),e.moveTo(l,u+P),e.lineTo(l+E,u+P),e.moveTo(l,u+P),e.lineTo(l,u+P+p),e.stroke())}}if(b-1==1||b-1==7)for(y=0;y<2;y++){m=0===y?-g:+g,P=0===y?+g:-g,p=0===y?+d:-d;var O=i+(b-1)*a;for(w=0;w<2;w++)for(u=(w%2==0?r+2*s:r+7*s)+P,x=0;x<2;x++){l=x%2==0?O+m:O-m,E=x%2==0?-p:+p;e.beginPath(),e.moveTo(l,u),e.lineTo(l+E,u),e.moveTo(l,u),e.lineTo(l,u+p),e.stroke()}}}}}),Object.defineProperty(e.prototype,"drawChoosePieceMovePoint",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this;if(this.choosePiece){var t=this,i=t.gridWidth,r=t.startX,n=t.startY,o=t.gridHeight;this.ctx.fillStyle="#25dd2a",this.choosePiece.getMovePoints(this.livePieceList).forEach((function(t){var a=r+Math.abs(t.x-e.gridDiffX)*i,s=n+Math.abs(t.y-e.gridDiffY)*o;e.ctx.beginPath(),e.ctx.arc(a,s,.25*e.radius,0,2*Math.PI),e.ctx.closePath(),e.ctx.fill()}))}}}),Object.defineProperty(e.prototype,"redraw",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.drawPeice(this.livePieceList)}}),Object.defineProperty(e.prototype,"activeMove",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){var n=this,o=i.x-e.x,a=i.y-e.y,s=0===o?0:o/this.moveSpeed,c=0===a?0:a/this.moveSpeed;return"function"==typeof this.animate&&"function"==typeof this.cancelAnimate?new Promise((function(o){var a,u=function(){var l=Math.abs(e.x-i.x),h=Math.abs(e.y-i.y);if(l<=Math.abs(s)&&h<=Math.abs(c)&&n.choosePiece)return n.cancelAnimate.call(globalThis,a),o(e);n.drawPeice(t);var f=r({},n.choosePiece);f.x=Math.abs(i.x-n.gridDiffX)-s,f.y=Math.abs(i.y-n.gridDiffY)-c,n.drawSinglePeice(n.ctx,f),i.x-=s,i.y-=c,a=n.animate.call(globalThis,u)};u()})):Promise.resolve(e)}}),Object.defineProperty(e.prototype,"moveToPeice",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(this.choosePiece){var t=this.currentSide,i="move"in e,r=i?e.move:e.eat,n=this.choosePiece;return this.checkGeneralInTrouble(t,this.choosePiece,e,this.livePieceList)?(this.moveFailEvents.forEach((function(e){return e(n,r,!0,"不可以送将！")})),{flag:!1,message:"不可以送将！"}):(i||(this.livePieceList=this.livePieceList.filter((function(e){return!(e.x===r.x&&e.y===r.y)}))),this.gameState="MOVE",this.moveStart(n,e,this.livePieceList,t))}return{flag:!1,message:"未选中棋子"}}}),Object.defineProperty(e.prototype,"movePeiceToPointAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return new Promise((function(r){if(i.choosePiece){var o=i.choosePiece,a=o.x,s=o.y,c=t.filter((function(e){return!(e.x===a&&e.y===s)})),u=new n(a,s);i.activeMove(e,c,u).then((function(e){i.moveEnd(e),r()}))}else r()}))}}),Object.defineProperty(e.prototype,"moveToPeiceAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(this.choosePiece){var t=this.currentSide,i="move"in e,r=i?e.move:e.eat,n=this.choosePiece;return this.checkGeneralInTrouble(t,this.choosePiece,e,this.livePieceList)?(this.moveFailEvents.forEach((function(e){return e(n,r,!0,"不可以送将！")})),Promise.resolve({flag:!1,message:"不可以送将！"})):(i||(this.livePieceList=this.livePieceList.filter((function(e){return!(e.x===r.x&&e.y===r.y)}))),this.gameState="MOVE",this.moveStartAsync(n,e,this.livePieceList,t).then((function(){return{flag:!0}})))}return Promise.resolve({flag:!1,message:"未选择棋子"})}}),Object.defineProperty(e.prototype,"moveStart",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,n){var o=this,a="RED"===n?"BLACK":"RED",s="move"in t?t.move:t.eat;this.moveEnd(s);var c=!1,u=this.checkGeneralInTrouble(a,e,t,i);if(u){var l=i.filter((function(t){return!(t.x===e.x&&t.y===e.y)})),h=d[e.name](r(r({},e),s));l.push(h),this.checkEnemySideInTroubleHasSolution(a,l)||(c=!0,this.gameState="OVER",this.winner=n)}else{this.checkEnemySideHasMovePoints(a)||(c=!0,this.gameState="OVER",this.winner=n)}return this.moveEvents.forEach((function(i){return i(e,t,c||u,o.getCurrentPenCode())})),c&&this.overEvents.forEach((function(e){return e(n)})),{flag:!0}}}),Object.defineProperty(e.prototype,"moveStartAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,n){var o=this,a="RED"===n?"BLACK":"RED",s="move"in t?t.move:t.eat;return this.movePeiceToPointAsync(s,i).then((function(){var c=o.checkGeneralInTrouble(a,e,{move:s},i),u=!1;if(c){var l=i.filter((function(t){return!(t.x===e.x&&t.y===e.y)})),h=d[e.name](r(r({},e),s));l.push(h),o.checkEnemySideInTroubleHasSolution(a,l)||(u=!0,o.gameState="OVER",o.winner=n)}else{o.checkEnemySideHasMovePoints(a)||(u=!0,o.gameState="OVER",o.winner=n)}return o.moveEvents.forEach((function(i){return i(e,t,u||c,o.getCurrentPenCode())})),u&&o.overEvents.forEach((function(e){return e(n)})),null}))}}),Object.defineProperty(e.prototype,"moveEnd",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;this.livePieceList=this.livePieceList.map((function(i){var n,o;if(i.x===(null===(n=t.choosePiece)||void 0===n?void 0:n.x)&&i.y===(null===(o=t.choosePiece)||void 0===o?void 0:o.y)){var a=r(r(r({},i),{isChoose:!1}),e);return d[i.name](a)}return i})),this.clearMoveChoosePeiece(),this.changeSide(),this.redraw(),this.gameState="START"}}),Object.defineProperty(e.prototype,"pieceMove",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=T(this.livePieceList,e);if(!this.choosePiece)return i?this.currentSide!==i.side?{flag:!1,message:"选中了敌方的棋子"}:(this.choosePiece=i,this.choosePiece.isChoose=!0,this.logEvents.forEach((function(e){return e("当前：".concat(t.currentSide," 方 选中了 棋子:").concat(i))})),this.redraw(),{flag:!0}):{flag:!1,message:"未找到棋子"};if(!i){var r=this.choosePiece.move(e,this.livePieceList),n=this.choosePiece;return r.flag?this.moveToPeice({move:e}):(this.moveFailEvents.forEach((function(t){return t(n,e,!0,r.message)})),r)}if(i.side===this.currentSide)return this.choosePiece===i?(this.clearMoveChoosePeiece(),this.logEvents.forEach((function(e){return e(t.currentSide+"方： 取消选中 "+i)})),this.redraw(),{flag:!0}):(this.choosePiece.isChoose=!1,this.logEvents.forEach((function(e){return e("".concat(t.currentSide,"方：切换 选中棋子 由").concat(t.choosePiece," --\x3e ").concat(i))})),this.choosePiece=i,this.choosePiece.isChoose=!0,this.redraw(),{flag:!0});this.logEvents.forEach((function(r){return r("当前：".concat(t.currentSide," ,棋子:").concat(t.choosePiece," 需要移动到：").concat(e," 这个点上，并且要吃掉 ").concat(i))}));var o=this.choosePiece.move(e,this.livePieceList);return o.flag?this.moveToPeice({eat:e}):(this.moveFailEvents.forEach((function(i){return i(t.choosePiece,e,!1,o.message)})),o)}}),Object.defineProperty(e.prototype,"pieceMoveAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=T(this.livePieceList,e);if(!this.choosePiece)return i?this.currentSide!==i.side?Promise.resolve({flag:!1,message:"选中了敌方的棋子"}):(this.choosePiece=i,this.choosePiece.isChoose=!0,this.logEvents.forEach((function(e){return e("当前：".concat(t.currentSide," 方 选中了 棋子:").concat(i))})),this.redraw(),this.drawChoosePieceMovePoint(),Promise.resolve({flag:!0})):Promise.resolve({flag:!1,message:"未找到棋子"});if(!i){var r=this.choosePiece.move(e,this.livePieceList),n=this.choosePiece;return r.flag?this.moveToPeiceAsync({move:e}):(this.moveFailEvents.forEach((function(t){return t(n,e,!0,r.message)})),Promise.resolve(r))}if(i.side===this.currentSide)return this.choosePiece===i?(this.clearMoveChoosePeiece(),this.logEvents.forEach((function(e){return e(t.currentSide+"方： 取消选中 "+i)})),this.redraw(),Promise.resolve({flag:!0})):(this.choosePiece.isChoose=!1,this.logEvents.forEach((function(e){return e("".concat(t.currentSide,"方：切换 选中棋子 由").concat(t.choosePiece," --\x3e ").concat(i))})),this.choosePiece=i,this.choosePiece.isChoose=!0,this.redraw(),this.drawChoosePieceMovePoint(),Promise.resolve({flag:!0}));this.logEvents.forEach((function(r){return r("当前：".concat(t.currentSide," ,棋子:").concat(t.choosePiece," 需要移动到：").concat(e," 这个点上，并且要吃掉 ").concat(i))}));var o=this.choosePiece.move(e,this.livePieceList);return o.flag?this.moveToPeiceAsync({eat:e}):(this.moveFailEvents.forEach((function(i){return i(t.choosePiece,e,!1,o.message)})),Promise.resolve(o))}}),Object.defineProperty(e.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){if(!this.checkGameState())return{flag:!1,message:"当前游戏状态不可以移动棋子"};if(this.currentSide!==i)return{flag:!1,message:"请等待对方下棋"};var r=T(this.livePieceList,e);return r&&r.side===this.currentSide?(this.choosePiece&&this.clearMoveChoosePeiece(),r.isChoose=!0,this.choosePiece=r,this.pieceMove(t)):(this.logEvents.forEach((function(e){return e("未找到棋子")})),{flag:!1,message:"未找到棋子"})}}),Object.defineProperty(e.prototype,"moveAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){if(!this.checkGameState())return Promise.resolve({flag:!1,message:"当前游戏状态不可以移动棋子"});if(this.currentSide!==i)return Promise.resolve({flag:!1,message:"当前为".concat(this.currentSide,"方下棋，请等待！")});var r=T(this.livePieceList,e);return r&&r.side===this.currentSide?(this.choosePiece&&this.clearMoveChoosePeiece(),r.isChoose=!0,this.choosePiece=r,this.pieceMoveAsync(t)):(this.logEvents.forEach((function(e){return e("未找到棋子")})),Promise.resolve({flag:!1,message:"未找到棋子"}))}}),Object.defineProperty(e.prototype,"moveStr",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;if(!this.checkGameState())return{flag:!1,message:"当前游戏状态不可以移动棋子"};if(this.logEvents.forEach((function(i){return i("当前 ".concat(t," 输出：").concat(e))})),this.currentSide!==t)return this.logEvents.forEach((function(e){return e("当前为".concat(i.currentSide,"方下棋，请等待！"))})),{flag:!1,message:"当前为".concat(this.currentSide,"方下棋，请等待！")};var r=S(e,this.currentSide,this.livePieceList);if(!r)return this.logEvents.forEach((function(e){return e("未找到棋子")})),{flag:!1,message:"未找到棋子"};this.choosePiece&&this.clearMoveChoosePeiece();var n=T(this.livePieceList,r.mp);return n&&n.side===this.currentSide?(this.logEvents.forEach((function(e){return e("移动的位置有己方棋子")})),{flag:!1,message:"移动的位置有己方棋子"}):(this.choosePiece=r.choose,this.choosePiece.isChoose=!0,this.pieceMove(r.mp))}}),Object.defineProperty(e.prototype,"moveStrAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;if(!this.checkGameState())return Promise.resolve({flag:!1,message:"当前游戏状态不可以移动棋子"});if(this.logEvents.forEach((function(i){return i("当前 ".concat(t," 输出：").concat(e))})),this.currentSide!==t)return this.logEvents.forEach((function(e){return e("当前为".concat(i.currentSide,"方下棋，请等待！"))})),Promise.resolve({flag:!1,message:"当前为".concat(this.currentSide,"方下棋，请等待！")});var r=S(e,this.currentSide,this.livePieceList);if(!r)return this.logEvents.forEach((function(e){return e("未找到棋子")})),Promise.resolve({flag:!1,message:"未找到棋子"});this.choosePiece&&this.clearMoveChoosePeiece();var n=T(this.livePieceList,r.mp);return n&&n.side===this.currentSide?(this.logEvents.forEach((function(e){return e("移动的位置有己方棋子")})),Promise.resolve({flag:!1,message:"移动的位置有己方棋子"})):(this.choosePiece=r.choose,this.choosePiece.isChoose=!0,this.pieceMoveAsync(r.mp))}}),Object.defineProperty(e.prototype,"gameStart",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.init(),this.setGridDiff(e),this.gameState="START",this.winner=null,this.gameSide=e,this.initPiece()}}),Object.defineProperty(e.prototype,"clearMoveChoosePeiece",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.choosePiece&&(this.choosePiece.isChoose=!1,this.choosePiece=null)}}),Object.defineProperty(e.prototype,"changeSide",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.currentSide="RED"===this.currentSide?"BLACK":"RED"}}),Object.defineProperty(e.prototype,"changePlaySide",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.setGridDiff(e),this.clearMoveChoosePeiece(),this.redraw()}}),Object.defineProperty(e.prototype,"changeCurrentPlaySide",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.currentSide=e}}),Object.defineProperty(e.prototype,"gameOver",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"OVER"===this.gameState}}),Object.defineProperty(e.prototype,"checkGeneralInTrouble",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,o){var a,s="BLACK"===e?"RED":"BLACK";if("move"in i){var c=r(r({},t),{x:i.move.x,y:i.move.y}),u=d[c.name](c);(a=o.filter((function(e){return!(e.x===t.x&&e.y===t.y)}))).push(u)}else{c=r(r({},t),{x:i.eat.x,y:i.eat.y}),u=d[c.name](c);(a=o.filter((function(e){return!(e.x===i.eat.x&&e.y===i.eat.y||e.x===t.x&&e.y===t.y)}))).push(u)}if(this.checkGeneralsFaceToFaceInTrouble(a))return!0;var l=a.filter((function(e){return e.side===s})),h=a.find((function(t){return t.side===e&&t instanceof f})),v=new n(h.x,h.y);return l.some((function(e){return e.move(v,a).flag}))}}),Object.defineProperty(e.prototype,"checkGeneralsFaceToFaceInTrouble",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e.filter((function(e){return e instanceof f})).map((function(e){return{x:e.x,y:e.y}})),i=t[0].y>t[1].y?t[0].y:t[1].y,r=t[0].y<t[1].y?t[0].y:t[1].y;return t[0].x===t[1].x&&!e.find((function(e){return e.y<i&&e.y>r&&e.x===t[0].x}))}}),Object.defineProperty(e.prototype,"checkEnemySideInTroubleHasSolution",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return t.filter((function(t){return t.side===e})).some((function(r){return r.getMovePoints(t).some((function(n){if(T(t,n.disPoint))return!1;var o=T(t,n)?{eat:n}:{move:n};return!i.checkGeneralInTrouble(e,r,o,t)}))}))}}),Object.defineProperty(e.prototype,"checkEnemySideHasMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=this.currentLivePieceList;return!!i.filter((function(t){return t.side===e})).find((function(r){return r.getMovePoints(i).find((function(n){var o=T(i,n)?{eat:n}:{move:n};return!t.checkGeneralInTrouble(e,r,o,i)}))}))}}),Object.defineProperty(e.prototype,"checkGameState",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"INIT"===this.gameState?(this.logEvents.forEach((function(e){return e("请选择红黑方")})),!1):"OVER"===this.gameState?(this.logEvents.forEach((function(e){return e("棋盘结束 等待重开！")})),!1):"MOVE"!==this.gameState||(this.logEvents.forEach((function(e){return e("棋子正在移动，无法做任何操作")})),!1)}}),Object.defineProperty(e.prototype,"listenClick",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e.offsetX,i=e.offsetY;if(this.checkGameState()){var r=this.getGridPosition({x:t,y:i});r&&this.pieceMove(r)}}}),Object.defineProperty(e.prototype,"listenClickAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,i,r=this,o=e.offsetX,a=e.offsetY;if(this.checkGameState()){var s=this.getGridPosition({x:o,y:a});if(s){var c=Boolean(this.choosePiece),u=c?new n(null===(t=this.choosePiece)||void 0===t?void 0:t.x,null===(i=this.choosePiece)||void 0===i?void 0:i.y):s,l=c?s:null,h=this.currentSide;this.updateAsync(u,l,h,(function(){r.draw(r.ctx)})).then((function(e){console.log(e),e.flag?(e.cb&&e.cb(),r.draw(r.ctx)):r.moveFailEvents.forEach((function(t){return t(u,l,e.message)}))}))}}}}),Object.defineProperty(e.prototype,"winnerSide",{get:function(){return this.winner},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentGameSide",{get:function(){return this.gameSide},set:function(e){console.log("设置值无效：".concat(e))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentLivePieceList",{get:function(){return this.livePieceList.map((function(e){return d[e.name](r({},e))}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentRadius",{get:function(){return this.radius},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"getCurrentPenCode",{enumerable:!1,configurable:!0,writable:!0,value:function(){return A(this.livePieceList,this.currentSide)}}),Object.defineProperty(e.prototype,"on",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if("function"!=typeof t)throw new Error("监听函数值应该为 function 类型");"log"===e?this.logEvents.push(t):"move"===e?this.moveEvents.push(t):"moveFail"===e?this.moveFailEvents.push(t):"over"===e&&this.overEvents.push(t)}}),Object.defineProperty(e.prototype,"removeEvent",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if("function"!=typeof t)throw new Error("监听函数值应该为 function 类型");"log"===e?this.logEvents=this.logEvents.filter((function(e){return e!==t})):"move"===e?this.moveEvents=this.moveEvents.filter((function(e){return e!==t})):"moveFail"===e?this.moveFailEvents=this.moveFailEvents.filter((function(e){return e!==t})):"over"===e&&(this.overEvents=this.overEvents.filter((function(e){return e!==t})))}}),Object.defineProperty(e.prototype,"setLivePieceList",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.livePieceList=e}}),e}();return e.CannonPiece=v,e.ElephantPiece=l,e.GeneralPiece=f,e.HorsePiece=u,e.KnightPiece=h,e.MovePoint=o,e.Piece=s,e.Point=n,e.RookPiece=c,e.SoldierPiece=b,e.chessOfPeiceMap=d,e.default=B,e.gen_PEN_Point_Str=function(e){var t=e.x,i=e.y;return String.fromCharCode(String(t).charCodeAt(0)+49)+String(9-i)},e.gen_PEN_Str=A,e.parse_PEN_Str=function(e){var t=function(e){return/\d/.test(e)},i=e.match(/(.*)\s+(w|b)\s*(-\s*-\s*(\d)+\s*(\d)+)?/);if(!i)throw new Error("不符合 PEN 棋盘布局代码格式!");var r=i[1],n=function(e){switch(e){case"b":case"B":return"BLACK";default:return"RED"}}(i[2]),o=i[4],a=i[5],s=r.split("/");if(10!==s.length)throw new Error("不符合 PEN 棋盘布局代码格式!");for(var c=[],u=0;u<s.length;u++){var l=s[u],h=9,f=l.length;if(f>9)throw new Error("不符合 PEN 棋盘布局代码格式!");for(var v=0;v<f;v++,h--){var b=l[v],d=M(b);if(d){var g=b.toLocaleLowerCase()===b?"BLACK":"RED";c.push({side:g,name:d,x:9-h,y:u})}else t(b)&&(h-=Number(b)-1)}}return{side:n,notEatRound:o,round:a,list:c}},e.peiceSideMap={RED:"红方",BLACK:"黑方"},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
