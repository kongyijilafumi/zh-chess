var ZhChess=function(e){"use strict";require("../modules/esnext.global-this");var t=require("../internals/global");module.exports=t;var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},r(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var n=function(){return n=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},n.apply(this,arguments)},o=function(){function e(e,t){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.x=e,this.y=t}return Object.defineProperty(e.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"(".concat(this.x,",").concat(this.y,")")}}),e}(),a=function(e){function t(t,r,i){var n=e.call(this,t,r)||this;return Object.defineProperty(n,"disPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),n.disPoint=new o(i.x,i.y),n}return i(t,e),Object.defineProperty(t.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=!(10===this.disPoint.x&&10===this.disPoint.y);return"(".concat(this.x,",").concat(this.y,")").concat(e?"<阻碍点"+this.disPoint+">":"")}}),t}(o),s={x:10,y:10},c=function(){function e(e){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"side",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isChoose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.x=e.x,this.y=e.y,this.name=e.name,this.side=e.side,this.isChoose=e.isChoose||!1}return Object.defineProperty(e.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"[".concat(this.side,"方]:").concat(this.name,"(").concat(this.x,",").concat(this.y,")")}}),Object.defineProperty(e.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r=this;return e.filter((function(e){var i=t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===r.side}));return e.x>=0&&e.x<=8&&e.y>=0&&e.y<=9&&!i}))}}),Object.defineProperty(e.prototype,"getCurrentInfo",{enumerable:!1,configurable:!0,writable:!0,value:function(){return{side:this.side,name:this.name,x:this.x,y:this.y}}}),Object.defineProperty(e.prototype,"update",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.x=e.x,this.y=e.y}}),Object.defineProperty(e.prototype,"draw",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r,i,n,o,a,s,c,u){var l=this.isChoose?"red":"#000",f=t+Math.abs(this.x-o)*i,h=r+Math.abs(this.y-a)*n,b=s,v=0;e.fillStyle=u;var d=function(t,r,i,n,o){e.beginPath(),e.arc(t,r,i,n,o),e.closePath(),e.stroke()};this.isChoose&&(b/=.98,v="RED"===this.side?-.3*s:.3*s,v=a>0?-1*v:v),e.beginPath(),e.arc(f,h+v,b,0,2*Math.PI),e.shadowOffsetX=3,e.shadowOffsetY=4,e.shadowColor="#333",e.shadowBlur=5,e.fill(),e.closePath(),e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.strokeStyle=l,d(f,h+v,b,0,2*Math.PI),d(f,h+v,b-3,0,2*Math.PI),e.textAlign="center",e.textBaseline="middle",e.fillStyle=c,e.font=s+"px yahei",e.fillText(this.name,f,h+v)}}),Object.defineProperty(e.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return[]}}),Object.defineProperty(e.prototype,"drawMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r,i,n,o,a,s,c,u){e.fillStyle=u,this.getMovePoints(t).forEach((function(t){var u=r+Math.abs(t.x-a)*n,l=i+Math.abs(t.y-s)*o;e.beginPath(),e.arc(u,l,.25*c,0,2*Math.PI),e.closePath(),e.fill()}))}}),Object.defineProperty(e.prototype,"getPoint",{enumerable:!1,configurable:!0,writable:!0,value:function(){return new o(this.x,this.y)}}),e}(),u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMoveObstaclePieceList",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r=this,i=this.x===e.x?"y":"x",n="x"===i?"y":"x",o=this[i]-e[i],a=o>0?e[i]:this[i],s=o<0?e[i]:this[i];return t.filter((function(t){var o=!(r.x===t.x&&r.y===t.y),c=t[n]===e[n],u=t[i]>a&&t[i]<s,l=t.side===r.side,f=t[i]>=a&&t[i]<=s;return c&&o&&u||c&&o&&l&&f}))}}),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(e.x<0||e.x>8||e.y<0||e.y>9)return{flag:!1,message:"移动位置不符合规则"};if(this.y===e.y||this.x===e.x){var r=this.getMoveObstaclePieceList(e,t);return r.length>0?{flag:!1,message:"移动距离中存在障碍物："+r.join("---")}:{flag:!0}}return{flag:!1,message:"移动位置不符合规则"}}}),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,r=Array.from({length:9},(function(e,r){return new a(r,t.y,s)})),i=Array.from({length:10},(function(e,r){return new a(t.x,r,s)})),n=r.concat(i).filter((function(e){return!(t.x===e.x&&t.y===e.y)}));return e?n.filter((function(r){return!0===t.move(r,e).flag})):n}}),t}(c),l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],r=0;r<2;r++){var i=this.x-2,n=2*r+(this.y-1);t.push(new a(i,n,{x:this.x-1,y:this.y}));var o=this.x+2,s=n;t.push(new a(o,s,{x:this.x+1,y:this.y}));var c=2*r+(this.x-1),u=this.y-2;t.push(new a(c,u,{x:this.x,y:this.y-1}));var l=c,f=this.y+2;t.push(new a(l,f,{x:this.x,y:this.y+1}))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(t,r){return e.prototype.filterMovePoints.call(this,t,r).filter((function(e){return!Boolean(function(e,t){return e.find((function(e){return e.x===t.x&&e.y===t.y}))}(r,e.disPoint))}))}}),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r=this.getMovePoints(t).find((function(t){return e.x===t.x&&e.y===t.y}));if(!r)return{flag:!1,message:"".concat(this,"走法错误，不可以落在").concat(e,"上")};var i=t.find((function(e){return e.x===r.disPoint.x&&e.y===r.disPoint.y}));return i?{flag:!1,message:"".concat(this,"走法错误，").concat(i,"卡住了").concat(this.name,"的去向")}:{flag:!0}}}),t}(c),f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],r=0;r<2;r++){var i=this.x-2+4*r,n=this.y-2,o=this.x-1+2*r,s=this.y-1;t.push(new a(i,n,{x:o,y:s}));var c=this.x-2+4*r,u=this.y+2,l=o,f=this.y+1;t.push(new a(c,u,{x:l,y:f}))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r=this;return e.filter((function(e){return!t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===r.side}))&&e.x>=0&&e.x<=8&&e.y>=0&&e.y<=9&&("RED"===r.side&&e.y>=5||"BLACK"===r.side&&e.y<=4)}))}}),t}(l),h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],r=0;r<2;r++){var i=this.x-1+2*r,n=this.y-1;t.push(new a(i,n,s));var o=this.x-1+2*r,c=this.y+1;t.push(new a(o,c,s))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r=this;return e.filter((function(e){return!t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===r.side}))&&e.x<=5&&e.x>=3&&("RED"===r.side&&e.y>=7&&e.y<=9||"BLACK"===r.side&&e.y>=0&&e.y<=2)}))}}),t}(f),b=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=[new a(this.x-1,this.y,s),new a(this.x+1,this.y,s),new a(this.x,this.y-1,s),new a(this.x,this.y+1,s)];return this.filterMovePoints(t,e)}}),t}(h),v=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(e.x<0||e.x>8||e.y<0||e.y>9)return{flag:!1,message:"移动位置不符合规则"};if(this.y===e.y||this.x===e.x){var r=this.getMoveObstaclePieceList(e,t);if(r.length>1)return{flag:!1,message:"移动距离存在多个炮架："+r.join("---")};if(1===r.length&&r[0].x===e.x&&r[0].y===e.y)return{flag:!1,message:"无法击中敌方棋子(缺少炮架)，移动无效"};if(1===r.length)return t.find((function(t){return t.x===e.x&&t.y===e.y}))?{flag:!0}:{flag:!1,message:"无法击中敌方棋子，移动无效"};var i=t.find((function(t){return t.x===e.x&&t.y===e.y}));return 0===r.length&&i?{flag:!1,message:"无法击中敌方棋子(缺少炮架)，移动无效"}:{flag:!0}}return{flag:!1,message:"移动位置不符合规则"}}}),t}(u),d=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t="RED"===this.side?this.y<=4:this.y>=5,r="RED"===this.side?-1:1,i=new a(this.x,this.y+r,s),n=t?[i,new a(this.x-1,this.y,s),new a(this.x+1,this.y,s)]:[i];return this.filterMovePoints(n,e)}}),t}(l),g={"仕":function(e){return new h(e)},"兵":function(e){return new d(e)},"卒":function(e){return new d(e)},"士":function(e){return new h(e)},"将":function(e){return new b(e)},"帅":function(e){return new b(e)},"炮":function(e){return new v(e)},"相":function(e){return new f(e)},"砲":function(e){return new v(e)},"象":function(e){return new f(e)},"車":function(e){return new u(e)},"车":function(e){return new u(e)},"馬":function(e){return new l(e)},"马":function(e){return new l(e)}},y=["前","中","后"],p=["进","平","退"],m="(".concat(p.join("|"),")"),P=["1","2","3","4","5","6","7","8","9"].concat(["一","二","三","四","五","六","七","八","九"]),w="(".concat(P.join("|"),")"),x="(".concat(Object.keys(g).join("|"),")"),O=new RegExp("(".concat(y.concat(P).join("|"),")").concat(x).concat(m).concat(w,"$")),E=new RegExp("".concat(x).concat(w).concat(m).concat(w,"$")),j=new RegExp("(".concat(y.join("|"),")").concat(w).concat(m).concat(w,"$")),S=function(e,t,r){var i,n,a,s=r.filter((function(e){return e.side===t})),c="RED"===t,u="BLACK"===t?8:0,l="BLACK"===t?9:0,f=c?1:-1;if(j.test(e)&&(n=j.exec(e))){var h=Math.abs(M(n[2])-1-u),b=n[3],v=M(n[4]),d=C("兵",t);if("平"===b&&(v-=1),(w=s.filter((function(e){return e.x===h&&e.name===d}))).length<2)return!1;w.sort((function(e,t){return c?e.y-t.y:t.y-e.y}));var g=w[3===w.length?M(n[1])-1:"前"===n[1]?0:1],m=Math.abs(g.y-l),P=c?m-v*f:m+v*f;if(b===p[0])return{mp:new o(g.x,P),choose:g};if(b===p[1])return{mp:new o(Math.abs(v-u),m),choose:g}}if(O.test(e)&&(i=O.exec(e))){O.lastIndex=0;var w,x=C(i[2],t);b=i[3],v=M(i[4]);if("平"===b&&(v-=1),(w=s.filter((function(e){return e.name===x}))).length<2)return!1;var S,k=0,L={};w.forEach((function(e){L[e.x]?L[e.x]+=1:L[e.x]=1}));for(var T=Object.keys(L),A=0;A<T.length;A++){var B=L[T[A]];if(k<B)k=B;else if(k===B)return!1}if(S=T[0],(k=L[S])<2)return!1;var R=w.filter((function(e){return String(e.x)===S})),D=i[1];if(D===y[1]&&3!==k)return!1;if(k>=3){R.sort((function(e,t){return c?e.y-t.y:t.y-e.y}));g=R[M(D)-1],m=Math.abs(g.y-l),P=c?m-v*f:m+v*f;if(b===p[0])return{mp:new o(g.x,P),choose:g};if(b===p[1])return{mp:new o(Math.abs(v-u),m),choose:g}}if(2===k&&y.filter((function(e){return"中"!==e})).includes(D)){m=(g=R[D===y[0]?0:1]).y;var G=(W=g.x)-v;if(b===p[0]||b===p[2]){var K=Math.abs(G),F=b===p[2]?-1:1;if("马"===x||"馬"===x){if(K>=1&&K<=2){var I=1==K;return{choose:g,mp:new o($=G<0?I?W-1*f:W-2*f:I?W+1*f:W+2*f,I?m-2*f*F:m-1*f*F)}}return!1}var X=["仕","士"];if((z=["相","象"].includes(x))||X.includes(x)){var Y=z?2:1;return(!z||3===K)&&(!(!z&&1!==K)&&{choose:g,mp:new o($=G>0?W+Y*f:W-Y*f,m-Y*f*F)})}return{choose:g,mp:new o(W,P=m-v*f*F)}}if(b===p[1])return{choose:g,mp:new o(Math.abs(v-u),m)}}return!1}if(E.test(e)&&(a=E.exec(e))){var _=C(a[1],t),H=M(a[2])-1;b=a[3],v=M(a[4]);"平"===b&&(v-=1);var N=Math.abs(H-u);if(!(g=s.filter((function(e){return e.x===N&&e.name===_}))).length)return!1;if(g.length>=2)return!1;m=g[0].y;var W=g[0].x;G=Math.abs(W-u)-v,K=Math.abs(G);if(b===p[0]||b===p[2]){F=b===p[2]?-1:1;if("马"===_||"馬"===_){var q=Math.abs(Math.abs(W-u)-(v-1));if(q>=1&&q<=2){var V=(I=1===q)?m-2*f*F:m-1*f*F,$=G+1<0?I?W+1*f:W+2*f:I?W-1*f:W-2*f;return{choose:g[0],mp:new o($,V)}}return!1}var z;X=["仕","士"];if((z=["相","象"].includes(_))||X.includes(_)){Y=z?2:1;if(z&&3!==K)return!1;if(!z&&1!==K)return!1;$=G>0?W+Y*f:W-Y*f;var U=m-Y*f*F;return{choose:g[0],mp:new o($,U)}}P=m-v*f*F;return{choose:g[0],mp:new o(W,P)}}if(b===p[1])return{choose:g[0],mp:new o(Math.abs(v-u),m)}}return!1};function C(e,t){switch(e){case"车":case"車":return"BLACK"===t?"車":"车";case"兵":case"卒":return"BLACK"===t?"卒":"兵";case"仕":case"士":return"BLACK"===t?"仕":"士";case"将":case"帅":return"BLACK"===t?"将":"帅";case"炮":case"砲":return"BLACK"===t?"砲":"炮";case"相":case"象":return"BLACK"===t?"象":"相";case"馬":case"马":return"BLACK"===t?"馬":"马";default:return null}}function M(e){switch(e){case"1":case"一":case"前":return 1;case"2":case"二":case"中":return 2;case"3":case"三":case"后":return 3;case"4":case"四":return 4;case"5":case"五":return 5;case"6":case"六":return 6;case"7":case"七":return 7;case"8":case"八":return 8;case"9":case"九":return 9;default:return 10}}function k(e){switch(e){case"K":return"帅";case"k":return"将";case"A":return"士";case"a":return"仕";case"B":return"相";case"b":return"象";case"N":return"马";case"n":return"馬";case"R":return"车";case"r":return"車";case"C":return"炮";case"c":return"砲";case"P":return"兵";case"p":return"卒";default:return null}}function L(e){switch(e){case"将":case"帅":return"k";case"仕":case"士":return"a";case"象":case"相":return"b";case"馬":case"马":return"n";case"車":case"车":return"r";case"砲":case"炮":return"c";case"卒":case"兵":return"p";default:return null}}function T(e){var t=function(e){return/\d/.test(e)},r=e.match(/(.*)\s+(w|b)\s*(-\s*-\s*(\d)+\s*(\d)+)?/);if(!r)throw new Error("不符合 PEN 棋盘布局代码格式!");var i=r[1],n=function(e){switch(e){case"b":case"B":return"BLACK";default:return"RED"}}(r[2]),o=r[4],a=r[5],s=i.split("/");if(10!==s.length)throw new Error("不符合 PEN 棋盘布局代码格式!");for(var c=[],u=0;u<s.length;u++){var l=s[u],f=9,h=l.length;if(h>9)throw new Error("不符合 PEN 棋盘布局代码格式!");for(var b=0;b<h;b++,f--){var v=l[b],d=k(v);if(d){var g=v.toLocaleLowerCase()===v?"BLACK":"RED";c.push({side:g,name:d,x:9-f,y:u})}else t(v)&&(f-=Number(v)-1)}}return{side:n,notEatRound:o,round:a,list:c}}function A(e,t){var r=Array.from({length:10},(function(){return[]}));e.forEach((function(e){var t=e.getCurrentInfo(),i=t.y;r[i].push(t)})),r=r.map((function(e){return e=e.sort((function(e,t){return e.x-t.x}))}));for(var i="",n=0;n<r.length;n++){var o=r[n],a=o.length;0===a&&(i+="9");for(var s=0;s<a;s++){var c=o[s],u="RED"===c.side,l=L(c.name);if(!l)throw new Error("未找到 ".concat(c.name,' 对应的 PEN 代码，请检查棋子名称是否符合正确格式:\n例如： 车 "车","車"...'));var f=c.x-(s>0?o[s-1].x+1:0);if(f>0&&(i+=String(f)),i+=u?l.toUpperCase():l,s+1===a){var h=8-c.x;h>0&&(i+=String(h))}}n<r.length-1&&(i+="/")}return i+" "+function(e){return"BLACK"===e?"b":"w"}(t)}var B="rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w";function R(e,t,r){return[n({},e),{x:t+e.x,y:e.y},{x:t+e.x,y:e.y+r},{x:e.x,y:e.y+r}]}var D=function(e,t){return e.find((function(e){return e.x===t.x&&e.y===t.y}))},G=function(){function e(e){var t,r=e.ctx,i=e.gameWidth,n=void 0===i?800:i,o=e.gameHeight,a=void 0===o?800:o,s=e.gamePadding,c=void 0===s?20:s,u=e.scaleRatio,l=void 0===u?1:u,f=e.duration,h=void 0===f?200:f,b=e.redPeiceBackground,v=void 0===b?"#feeca0":b,d=e.blackPeiceBackground,g=void 0===d?"#fdec9e":d,y=e.checkerboardBackground,p=void 0===y?"#faebd7":y,m=e.movePointColor,P=void 0===m?"#25dd2a":m,w=e.drawMovePoint,x=void 0===w||w;Object.defineProperty(this,"currentSide",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"livePieceList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"choosePiece",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridHeight",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"radius",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ctx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridPostionList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"duration",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawMovePoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridDiffX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridDiffY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gameState",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"moveEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"moveFailEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"overEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"errorEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"redPeiceBackground",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blackPeiceBackground",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkerboardBackground",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"winner",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"gameSide",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"animate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cancelAnimate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scaleRatio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"movePointColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.moveEvents=[],this.moveFailEvents=[],this.logEvents=[],this.overEvents=[],this.errorEvents=[],this.ctx=r,this.redPeiceBackground=v,this.blackPeiceBackground=g,this.checkerboardBackground=p,this.movePointColor=P,null===(t=this.ctx)||void 0===t||t.scale(l,l),this.scaleRatio=l,this.listenClick=this.listenClick.bind(this),this.listenClickAsync=this.listenClickAsync.bind(this),this.checkDraw=this.checkDraw.bind(this),this.gridPostionList=[],this.drawMovePoint=x,this.setGridList(),this.gameState="INIT",this.duration=h,this.setGameWindow(n,a,c),this.init(),this.animate=globalThis.requestAnimationFrame||globalThis.webkitRequestAnimationFrame||globalThis.mozRequestAnimationFrame||globalThis.oRequestAnimationFrame||globalThis.msRequestAnimationFrame||function(e){return globalThis.setTimeout(e,1e3/60)},this.cancelAnimate=globalThis.cancelAnimationFrame||globalThis.webkitCancelAnimationFrame||globalThis.mozCancelAnimationFrame||globalThis.oCancelAnimationFrame||globalThis.msCancelAnimationFrame||globalThis.clearTimeout}return Object.defineProperty(e.prototype,"setGameWindow",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r){for(var i=t-2*r,n=i;n%9!=0;)n++;this.gridWidth=n/9,this.gridHeight=i/10,this.startX=(e-n+this.gridWidth)/2,this.startY=(t-i+this.gridHeight)/2,this.endX=this.startX+8*this.gridWidth,this.endY=this.startY+9*this.gridHeight,this.radius=.45*this.gridHeight,this.width=e,this.height=t}}),Object.defineProperty(e.prototype,"getGridDiff",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){return"BLACK"===e?"x"===t?8:9:0}}),Object.defineProperty(e.prototype,"setGridDiff",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.gridDiffX=this.getGridDiff(e,"x"),this.gridDiffY=this.getGridDiff(e,"y")}}),Object.defineProperty(e.prototype,"setGridList",{enumerable:!1,configurable:!0,writable:!0,value:function(){for(var e=0;e<9;e++)for(var t=0;t<10;t++)this.gridPostionList.push(new o(e,t))}}),Object.defineProperty(e.prototype,"getGridPosition",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;return this.gridPostionList.find((function(r){var i=Math.abs(r.x-t.gridDiffX)*t.gridWidth+t.startX,n=Math.abs(r.y-t.gridDiffY)*t.gridHeight+t.startY;return Math.sqrt(Math.pow(i-e.x,2)+Math.pow(n-e.y,2))<t.radius}))}}),Object.defineProperty(e.prototype,"init",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.currentSide="RED",this.choosePiece=null,this.livePieceList=[]}}),Object.defineProperty(e.prototype,"initPiece",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.setPenCodeList(B),this.choosePiece=null,this.checkDraw()}}),Object.defineProperty(e.prototype,"updateAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r,i,n){var a=this,s=this.update(e,t,r,!1);if(this.gameState="MOVE",!s.flag||!t||s.flag&&!s.move)return this.gameState="START",Promise.resolve(s);var c,u,l=e.x-t.x,f=e.y-t.y,h=e.x,b=e.y,v=l/(this.duration/16),d=f/(this.duration/16);return new Promise((function(r){var s=function(){if(Math.abs(h-t.x)<=Math.abs(v)&&Math.abs(b-t.y)<=Math.abs(d))return a.cancelAnimate.call(globalThis,c),u&&u.update(e),r(null);var l=new o(h,b);u=D(a.livePieceList,l);var f=new o(h-=v,b-=d);u&&(u.isChoose=!1,u.update(f),i&&a.checkDraw(),"function"==typeof n&&n(u,f)),c=a.animate.call(globalThis,s)};s()})).catch((function(e){return a.errorEvents.forEach((function(t){return t(e)})),null})).then((function(){return s.flag&&s.cb?(s.cb(),i&&a.checkDraw(),{flag:!0,move:!0}):s}))}}),Object.defineProperty(e.prototype,"update",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r,i){var o=this,a=this.checkGameState();if(!a.flag)return a;if(this.currentSide!==r)return{flag:!1,message:"请等待对方下棋"};var s=D(this.livePieceList,e);if(!s)return{flag:!1,message:"未找到棋子"};if(this.currentSide!==s.side)return{flag:!1,message:"选中了敌方的棋子"};if(this.clearMoveChoosePeiece(),s.isChoose=!0,this.choosePiece=s,!t)return this.logEvents.forEach((function(e){return e(r+"方： 选中 "+s)})),{flag:!0,move:!1};var c=D(this.livePieceList,t),u=this.choosePiece.move(t,this.livePieceList),l=function(a){var c="move"in a;if(o.checkGeneralInTrouble(r,s,a,o.livePieceList))return{flag:!1,message:"不可以送将！"};var u="RED"===r?"BLACK":"RED",l=!1,f=o.checkGeneralInTrouble(u,s,a,o.livePieceList),h=c?o.livePieceList.filter((function(e){return!(e.x===s.x&&e.y===s.y)})):o.livePieceList.filter((function(e){return!(e.x===s.x&&e.y===s.y||e.x===a.eat.x&&e.y===a.eat.y)})),b=g[s.name](n(n({},s),t));(h.push(b),f)?o.checkEnemySideInTroubleHasSolution(u,h)||(l=!0,o.winner=r):o.checkEnemySideHasMovePoints(u,h)||(l=!0,o.winner=r);var v=function(){var i=g[s.name](n(n({},s),e));c||(o.livePieceList=o.livePieceList.filter((function(e){return!(e.x===a.eat.x&&e.y===a.eat.y)}))),s.update(t),o.gameState="START",l&&(o.gameState="OVER"),o.moveEvents.forEach((function(e){return e(i,a,l||f,o.getCurrentPenCode(u))})),l&&o.overEvents.forEach((function(e){return e(r)})),o.clearMoveChoosePeiece(),o.changeSide()};return i?(v(),{flag:!0,move:!0}):{flag:!0,cb:v,move:!0}};return c?c.side===r?e.x===t.x&&e.y===t.y?(this.clearMoveChoosePeiece(),this.logEvents.forEach((function(e){return e(r+"方： 取消选中 "+c)})),{flag:!0,move:!1}):(this.choosePiece.isChoose=!1,this.choosePiece=c,this.choosePiece.isChoose=!0,this.logEvents.forEach((function(e){return e("".concat(o.currentSide,"方：切换 选中棋子 由").concat(o.choosePiece," --\x3e ").concat(c))})),{flag:!0,move:!1}):(this.logEvents.forEach((function(e){return e("当前：".concat(o.currentSide," ,棋子:").concat(o.choosePiece," 需要移动到：").concat(t," 这个点上，并且要吃掉 ").concat(c))})),u.flag?l({eat:t}):u):u.flag?l({move:t}):u}}),Object.defineProperty(e.prototype,"draw",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;e.clearRect(0,0,this.width,this.height),this.drawChessLine(e);var r=this,i=r.startX,n=r.startY,o=r.gridWidth,a=r.gridHeight,s=r.gridDiffX,c=r.gridDiffY,u=r.radius;if(this.livePieceList.forEach((function(r){var l="BLACK"===r.side?"#000":"#c1190c",f="BLACK"===r.side?t.blackPeiceBackground:t.redPeiceBackground;t.choosePiece!==r&&r.draw(e,i,n,o,a,s,c,u,l,f)})),this.choosePiece){var l="BLACK"===this.choosePiece.side?"#000":"#c1190c",f="BLACK"===this.choosePiece.side?this.blackPeiceBackground:this.redPeiceBackground;this.choosePiece.draw(e,i,n,o,a,s,c,u,l,f),this.drawMovePoint&&"MOVE"!==this.gameState&&this.choosePiece.drawMovePoints(e,this.livePieceList,i,n,o,a,s,c,u,this.movePointColor)}}}),Object.defineProperty(e.prototype,"drawChessLine",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,r=t.startX,i=t.startY,n=t.endX,o=t.endY,a=t.gridWidth,s=t.gridHeight,c=t.scaleRatio;e.fillStyle=this.checkerboardBackground,e.fillRect(0,0,this.width,this.width),e.strokeStyle="#000";for(var u=0;u<10;u++){e.beginPath();var l=i+s*u;e.moveTo(r,l),e.lineTo(n,l),e.closePath(),e.stroke()}for(u=0;u<9;u++){var f=r+u*a,h=i+4*s,b=i+9*s;0!==u&&8!==u?(e.beginPath(),e.moveTo(f,i),e.lineTo(f,h),e.closePath(),e.stroke(),e.beginPath(),e.moveTo(f,h+s),e.lineTo(f,o),e.closePath(),e.stroke()):(e.beginPath(),e.moveTo(f,i),e.lineTo(f,b),e.closePath(),e.stroke())}for(u=0;u<2;u++){var v=R({x:f=r+3*a,y:i+7*s*u},2*a,2*s);e.beginPath(),e.moveTo(v[0].x,v[0].y),e.lineTo(v[2].x,v[2].y),e.moveTo(v[1].x,v[1].y),e.lineTo(v[3].x,v[3].y),e.closePath(),e.stroke()}for(var d=0;d<9;d+=2){for(var g=.15*a,y=.1*a,p=0;p<2;p++)for(var m=0===p?-y:+y,P=0===p?+y:-y,w=0===p?+g:-g,x=0;x<2;x++){l=x%2==0?i+3*s:i+6*s;for(var O=0;O<2;O++){var E=O%2==0?-w:+w;(f=O%2==0?r+d*a+m:r+d*a-m)-r>0&&f-(r+8*a)<0&&(e.beginPath(),e.moveTo(f,l+P),e.lineTo(f+E,l+P),e.moveTo(f,l+P),e.lineTo(f,l+P+w),e.stroke())}}if(d-1==1||d-1==7)for(p=0;p<2;p++){m=0===p?-y:+y,P=0===p?+y:-y,w=0===p?+g:-g;var j=r+(d-1)*a;for(x=0;x<2;x++)for(l=(x%2==0?i+2*s:i+7*s)+P,O=0;O<2;O++){f=O%2==0?j+m:j-m,E=O%2==0?-w:+w;e.beginPath(),e.moveTo(f,l),e.lineTo(f+E,l),e.moveTo(f,l),e.lineTo(f,l+w),e.stroke()}}}e.textBaseline="middle",e.textAlign="left",e.fillStyle="#000";var S=.7*s;e.font=S+"px serif",e.fillText("楚河",r+a,i+4.5*s),e.textAlign="right",e.translate(r+7*a-2*S,i+4.5*s),e.rotate(Math.PI),e.fillText("汉界",0,0),e.setTransform(c,0,0,c,0,0)}}),Object.defineProperty(e.prototype,"moveStr",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r=this;if(!this.checkGameState())return{flag:!1,message:"当前游戏状态不可以移动棋子"};if(this.logEvents.forEach((function(r){return r("当前 ".concat(t," 输出：").concat(e))})),this.currentSide!==t)return this.logEvents.forEach((function(e){return e("当前为".concat(r.currentSide,"方下棋，请等待！"))})),{flag:!1,message:"当前为".concat(this.currentSide,"方下棋，请等待！")};var i=S(e,this.currentSide,this.livePieceList);if(!i)return this.logEvents.forEach((function(e){return e("未找到棋子")})),{flag:!1,message:"未找到棋子"};this.choosePiece&&this.clearMoveChoosePeiece();var n=D(this.livePieceList,i.mp);return n&&n.side===this.currentSide?(this.logEvents.forEach((function(e){return e("移动的位置有己方棋子")})),{flag:!1,message:"移动的位置有己方棋子"}):(this.choosePiece=i.choose,this.choosePiece.isChoose=!0,this.update(i.choose,i.mp,t,!0))}}),Object.defineProperty(e.prototype,"moveStrAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r){var i=this;if(!this.checkGameState())return Promise.resolve({flag:!1,message:"当前游戏状态不可以移动棋子"});if(this.logEvents.forEach((function(r){return r("当前 ".concat(t," 输出：").concat(e))})),this.currentSide!==t)return this.logEvents.forEach((function(e){return e("当前为".concat(i.currentSide,"方下棋，请等待！"))})),Promise.resolve({flag:!1,message:"当前为".concat(this.currentSide,"方下棋，请等待！")});var n=S(e,this.currentSide,this.livePieceList);return n?(this.choosePiece&&this.clearMoveChoosePeiece(),this.choosePiece=n.choose,this.choosePiece.isChoose=!0,this.updateAsync(n.choose.getPoint(),n.mp,t,r)):(this.logEvents.forEach((function(e){return e("未找到棋子")})),Promise.resolve({flag:!1,message:"未找到棋子"}))}}),Object.defineProperty(e.prototype,"gameStart",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.init(),this.setGridDiff(e),this.gameState="START",this.winner=null,this.initPiece(),this.gameSide=e}}),Object.defineProperty(e.prototype,"clearMoveChoosePeiece",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.choosePiece&&(this.choosePiece.isChoose=!1,this.choosePiece=null)}}),Object.defineProperty(e.prototype,"changeSide",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.currentSide="RED"===this.currentSide?"BLACK":"RED"}}),Object.defineProperty(e.prototype,"changePlaySide",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.setGridDiff(e),this.clearMoveChoosePeiece(),this.checkDraw()}}),Object.defineProperty(e.prototype,"changeCurrentPlaySide",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.currentSide=e}}),Object.defineProperty(e.prototype,"gameOver",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"OVER"===this.gameState}}),Object.defineProperty(e.prototype,"checkGeneralInTrouble",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r,i){var a,s="BLACK"===e?"RED":"BLACK";if("move"in r){var c=n(n({},t),r.move),u=g[c.name](c);(a=i.filter((function(e){return!(e.x===t.x&&e.y===t.y)}))).push(u)}else{c=n(n({},t),r.eat),u=g[c.name](c);(a=i.filter((function(e){return!(e.x===r.eat.x&&e.y===r.eat.y||e.x===t.x&&e.y===t.y)}))).push(u)}if(this.checkGeneralsFaceToFaceInTrouble(a))return!0;var l=a.filter((function(e){return e.side===s})),f=a.find((function(t){return t.side===e&&t instanceof b})),h=new o(f.x,f.y);return l.some((function(e){return e.move(h,a).flag}))}}),Object.defineProperty(e.prototype,"checkGeneralsFaceToFaceInTrouble",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e.filter((function(e){return e instanceof b})).map((function(e){return{x:e.x,y:e.y}})),r=t[0].y>t[1].y?t[0].y:t[1].y,i=t[0].y<t[1].y?t[0].y:t[1].y;return t[0].x===t[1].x&&!e.find((function(e){return e.y<r&&e.y>i&&e.x===t[0].x}))}}),Object.defineProperty(e.prototype,"checkEnemySideInTroubleHasSolution",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r=this;return t.filter((function(t){return t.side===e})).some((function(i){return i.getMovePoints(t).some((function(n){if(D(t,n.disPoint))return!1;var o=D(t,n)?{eat:n}:{move:n};return!r.checkGeneralInTrouble(e,i,o,t)}))}))}}),Object.defineProperty(e.prototype,"checkEnemySideHasMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var r=this,i=t;return!!i.filter((function(t){return t.side===e})).find((function(t){return t.getMovePoints(i).find((function(n){var o=D(i,n)?{eat:n}:{move:n};return!r.checkGeneralInTrouble(e,t,o,i)}))}))}}),Object.defineProperty(e.prototype,"checkGameState",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e;if(!(e="INIT"===this.gameState?{flag:!1,message:"请选择红黑方"}:"OVER"===this.gameState?{flag:!1,message:"棋盘结束 等待重开！"}:"MOVE"===this.gameState?{flag:!1,message:"棋子正在移动，无法做任何操作"}:{flag:!0}).flag){var t=e.message;this.logEvents.forEach((function(e){return e(t)})),this.moveFailEvents.forEach((function(e){return e(null,null,t)}))}return e}}),Object.defineProperty(e.prototype,"checkDraw",{enumerable:!1,configurable:!0,writable:!0,value:function(){if(this.ctx)try{this.draw(this.ctx)}catch(e){this.errorEvents.forEach((function(t){return t(e)}))}else this.errorEvents.forEach((function(e){return e(new Error("未找到画布，无法更新当前棋盘布局画面！"))}))}}),Object.defineProperty(e.prototype,"listenClick",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,r,i=e.offsetX,n=e.offsetY;if(this.checkGameState().flag){var a=this.getGridPosition({x:i,y:n});if(!a){var s="点击的位置未找到棋子";return this.logEvents.forEach((function(e){return e(s)})),void this.moveFailEvents.forEach((function(e){return e(null,null,s)}))}var c=Boolean(this.choosePiece),u=c?new o(null===(t=this.choosePiece)||void 0===t?void 0:t.x,null===(r=this.choosePiece)||void 0===r?void 0:r.y):a,l=c?a:null,f=this.currentSide;this.update(u,l,f,!0),this.checkDraw()}}}),Object.defineProperty(e.prototype,"listenClickAsync",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,r,i=this,n=e.offsetX,a=e.offsetY;if(this.checkGameState().flag){var s=this.getGridPosition({x:n,y:a});if(!s){var c="点击的位置未找到棋子";return this.logEvents.forEach((function(e){return e(c)})),void this.moveFailEvents.forEach((function(e){return e(null,null,c)}))}var u=Boolean(this.choosePiece),l=u?new o(null===(t=this.choosePiece)||void 0===t?void 0:t.x,null===(r=this.choosePiece)||void 0===r?void 0:r.y):s,f=u?s:null,h=this.currentSide;this.updateAsync(l,f,h,!0).then((function(e){i.checkDraw(),e.flag||i.moveFailEvents.forEach((function(t){return t(l,f,e.message)}))}))}}}),Object.defineProperty(e.prototype,"winnerSide",{get:function(){return this.winner},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentGameSide",{get:function(){return this.gameSide},set:function(e){console.log("设置值无效：".concat(e))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentLivePieceList",{get:function(){return this.livePieceList.map((function(e){return g[e.name](n({},e))}))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentRadius",{get:function(){return this.radius},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"getCurrentPenCode",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return A(this.livePieceList,e)}}),Object.defineProperty(e.prototype,"on",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if("function"!=typeof t)throw new Error("监听函数值应该为 function 类型");"log"===e?this.logEvents.push(t):"move"===e?this.moveEvents.push(t):"moveFail"===e?this.moveFailEvents.push(t):"over"===e?this.overEvents.push(t):"error"===e&&this.errorEvents.push(t)}}),Object.defineProperty(e.prototype,"removeEvent",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if("function"!=typeof t)throw new Error("监听函数值应该为 function 类型");"log"===e?this.logEvents=this.logEvents.filter((function(e){return e!==t})):"move"===e?this.moveEvents=this.moveEvents.filter((function(e){return e!==t})):"moveFail"===e?this.moveFailEvents=this.moveFailEvents.filter((function(e){return e!==t})):"over"===e?this.overEvents=this.overEvents.filter((function(e){return e!==t})):"error"===e&&(this.errorEvents=this.errorEvents.filter((function(e){return e!==t})))}}),Object.defineProperty(e.prototype,"setLivePieceList",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.livePieceList=e}}),Object.defineProperty(e.prototype,"setPenCodeList",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=T(e);this.livePieceList=t.list.map((function(e){return g[e.name](e)})),this.currentSide=t.side}}),e}();return e.CannonPiece=v,e.ElephantPiece=f,e.GeneralPiece=b,e.HorsePiece=l,e.KnightPiece=h,e.MovePoint=a,e.Piece=c,e.Point=o,e.RookPiece=u,e.SoldierPiece=d,e.chessOfPeiceMap=g,e.default=G,e.diffPenStr=function(e,t){var r=T(e).list,i=T(t).list,n=r.map((function(e){return g[e.name](e)})),a=[],s=[];return r.forEach((function(e){var t=i.findIndex((function(t){return t.x===e.x&&e.y===t.y&&e.side===t.side&&t.name===e.name}));if(-1===t){var r=g[e.name](e).getMovePoints(n);if(r.length)r.find((function(t){var r=i.findIndex((function(r){return r.x===t.x&&r.y===t.y&&r.side===e.side&&r.name===e.name})),n=-1!==r;return n&&(s.push({point:new o(e.x,e.y),move:new o(i[r].x,i[r].y),side:e.side}),i.splice(r,1)),n}))||a.push(e);else a.push(e)}else i.splice(t,1)})),{moveList:s,delList:a}},e.gen_PEN_Point_Str=function(e){var t=e.x,r=e.y;return String.fromCharCode(String(t).charCodeAt(0)+49)+String(9-r)},e.gen_PEN_Str=A,e.initBoardPen=B,e.parse_PEN_Str=T,e.peiceSideMap={RED:"红方",BLACK:"黑方"},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
