var zhChess=function(e){"use strict";var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},t(e,i)};function i(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}var r=function(){return r=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},r.apply(this,arguments)},n=function(){function e(e,t){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.x=e,this.y=t}return Object.defineProperty(e.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"(".concat(this.x,",").concat(this.y,")")}}),e}(),o=function(e){function t(t,i,r){var o=e.call(this,t,i)||this;return Object.defineProperty(o,"disPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),o.disPoint=new n(r.x,r.y),o}return i(t,e),Object.defineProperty(t.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=!(10===this.disPoint.x&&10===this.disPoint.y);return"(".concat(this.x,",").concat(this.y,")").concat(e?"<阻碍点"+this.disPoint+">":"")}}),t}(n),s={x:10,y:10},a=function(){function e(e){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"radius",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"side",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isChoose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.x=e.x,this.y=e.y,this.radius=e.radius,this.name=e.name,this.side=e.side,this.isChoose=e.isChoose}return Object.defineProperty(e.prototype,"toString",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"[".concat(this.side,"方]:").concat(this.name,"(").concat(this.x,",").concat(this.y,")")}}),Object.defineProperty(e.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return e.filter((function(e){var r=t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===i.side}));return e.x>=0&&e.x<=8&&e.y>=0&&e.y<=9&&!r}))}}),e}(),c=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,"getMoveObstaclePieceList",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this,r=this.x===e.x?"y":"x",n="x"===r?"y":"x",o=this[r]-e[r],s=o>0?e[r]:this[r],a=o<0?e[r]:this[r];return t.filter((function(t){var o=!(i.x===t.x&&i.y===t.y),c=t[n]===e[n],u=t[r]>s&&t[r]<a,h=t.side===i.side,l=t[r]>=s&&t[r]<=a;return c&&o&&u||c&&o&&h&&l}))}}),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(e.x<0||e.x>8||e.y<0||e.y>9)return{flag:!1,message:"移动位置不符合规则"};if(this.y===e.y||this.x===e.x){var i=this.getMoveObstaclePieceList(e,t);return i.length>0?{flag:!1,message:"移动距离中存在障碍物："+i.join("---")}:{flag:!0}}return{flag:!1,message:"移动位置不符合规则"}}}),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=Array.from({length:9},(function(e,i){return new o(i,t.y,s)})),r=Array.from({length:10},(function(e,i){return new o(t.x,i,s)})),n=i.concat(r).filter((function(e){return!(t.x===e.x&&t.y===e.y)}));return e?n.filter((function(i){return!0===t.move(i,e).flag})):n}}),t}(a),u=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],i=0;i<2;i++){var r=this.x-2,n=2*i+(this.y-1);t.push(new o(r,n,{x:this.x-1,y:this.y}));var s=this.x+2,a=n;t.push(new o(s,a,{x:this.x+1,y:this.y}));var c=2*i+(this.x-1),u=this.y-2;t.push(new o(c,u,{x:this.x,y:this.y-1}));var h=c,l=this.y+2;t.push(new o(h,l,{x:this.x,y:this.y+1}))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this.getMovePoints(t).find((function(t){return e.x===t.x&&e.y===t.y}));if(!i)return{flag:!1,message:"".concat(this,"走法错误，不可以落在").concat(e,"上")};var r=t.find((function(e){return e.x===i.disPoint.x&&e.y===i.disPoint.y}));return r?{flag:!1,message:"".concat(this,"走法错误，").concat(r,"卡住了").concat(this.name,"的去向")}:{flag:!0}}}),t}(a),h=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],i=0;i<2;i++){var r=this.x-2+4*i,n=this.y-2,s=this.x-1+2*i,a=this.y-1;t.push(new o(r,n,{x:s,y:a}));var c=this.x-2+4*i,u=this.y+2,h=s,l=this.y+1;t.push(new o(c,u,{x:h,y:l}))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return e.filter((function(e){return!t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===i.side}))&&e.x>=0&&e.x<=8&&e.y>=0&&e.y<=9&&("RED"===i.side&&e.y>=5||"BLACK"===i.side&&e.y<=4)}))}}),t}(u),l=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var t=[],i=0;i<2;i++){var r=this.x-1+2*i,n=this.y-1;t.push(new o(r,n,s));var a=this.x-1+2*i,c=this.y+1;t.push(new o(a,c,s))}return this.filterMovePoints(t,e)}}),Object.defineProperty(t.prototype,"filterMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return e.filter((function(e){return!t.find((function(t){return t.x===e.x&&t.y===e.y&&t.side===i.side}))&&e.x<=5&&e.x>=3&&("RED"===i.side&&e.y>=7&&e.y<=9||"BLACK"===i.side&&e.y>=0&&e.y<=2)}))}}),t}(h),f=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=[new o(this.x-1,this.y,s),new o(this.x+1,this.y,s),new o(this.x,this.y-1,s),new o(this.x,this.y+1,s)];return this.filterMovePoints(t,e)}}),t}(l),v=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(e.x<0||e.x>8||e.y<0||e.y>9)return{flag:!1,message:"移动位置不符合规则"};if(this.y===e.y||this.x===e.x){var i=this.getMoveObstaclePieceList(e,t);if(i.length>1)return{flag:!1,message:"移动距离存在多个炮架："+i.join("---")};if(1===i.length&&i[0].x===e.x&&i[0].y===e.y)return{flag:!1,message:"无法击中敌方棋子(缺少炮架)，移动无效"};if(1===i.length)return t.find((function(t){return t.x===e.x&&t.y===e.y}))?{flag:!0}:{flag:!1,message:"无法击中敌方棋子，移动无效"};var r=t.find((function(t){return t.x===e.x&&t.y===e.y}));return 0===i.length&&r?{flag:!1,message:"无法击中敌方棋子(缺少炮架)，移动无效"}:{flag:!0}}return{flag:!1,message:"移动位置不符合规则"}}}),t}(c),b=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,"getMovePoints",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t="RED"===this.side?this.y<=4:this.y>=5,i="RED"===this.side?-1:1,r=new o(this.x,this.y+i,s),n=t?[r,new o(this.x-1,this.y,s),new o(this.x+1,this.y,s)]:[r];return this.filterMovePoints(n,e)}}),t}(u),d={"仕":function(e){return new l(e)},"兵":function(e){return new b(e)},"卒":function(e){return new b(e)},"士":function(e){return new l(e)},"将":function(e){return new f(e)},"帅":function(e){return new f(e)},"炮":function(e){return new v(e)},"相":function(e){return new h(e)},"砲":function(e){return new v(e)},"象":function(e){return new h(e)},"車":function(e){return new c(e)},"车":function(e){return new c(e)},"馬":function(e){return new u(e)},"马":function(e){return new u(e)}},y=function(e,t){return e.find((function(e){return e.x===t.x&&e.y===t.y}))},g=["前","中","后"],p=["进","平","退"],m=["1","2","3","4","5","6","7","8","9"].concat(["一","二","三","四","五","六","七","八","九"]),x=m.join("|"),P=Object.keys(d),w=new RegExp("(".concat(g.concat(m).join("|"),")(").concat(P.join("|"),")(").concat(p.join("|"),")(").concat(x,")$")),O=new RegExp("(".concat(P.join("|"),")(").concat(x,")(").concat(p.join("|"),")(").concat(x,")$")),j=new RegExp("(".concat(g.join("|"),")(").concat(x,")(").concat(p.join("|"),")(").concat(x,")$"));function E(e,t){switch(e){case"车":case"車":return"BLACK"===t?"車":"车";case"兵":case"卒":return"BLACK"===t?"卒":"兵";case"仕":case"士":return"BLACK"===t?"仕":"士";case"将":case"帅":return"BLACK"===t?"将":"帅";case"炮":case"砲":return"BLACK"===t?"砲":"炮";case"相":case"象":return"BLACK"===t?"象":"相";case"馬":case"马":return"BLACK"===t?"馬":"马";default:return null}}function C(e){switch(e){case"1":case"一":case"前":return 1;case"2":case"二":case"中":return 2;case"3":case"三":case"后":return 3;case"4":case"四":return 4;case"5":case"五":return 5;case"6":case"六":return 6;case"7":case"七":return 7;case"8":case"八":return 8;case"9":case"九":return 9;default:return 10}}var M=function(){function e(e){var t=e.ctx,i=e.gameWidth,r=void 0===i?800:i,n=e.gameHeight,o=void 0===n?800:n,s=e.gamePadding,a=void 0===s?20:s,c=e.scaleRatio,u=void 0===c?1:c;if(Object.defineProperty(this,"currentSide",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"livePieceList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"deadPieceList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"choosePiece",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridHeight",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"radius",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ctx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridPostionList",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isMoving",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"moveSpeed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gameSide",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridDiffX",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gridDiffY",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gameState",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"moveEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"moveFailEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"overEvents",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!t)throw new Error("请传入画布");this.moveEvents=[],this.moveFailEvents=[],this.logEvents=[],this.overEvents=[],this.ctx=t,this.ctx.scale(u,u),this.listenClick=this.listenClick.bind(this),this.gridPostionList=[],this.setGridList(),this.moveSpeed=8,this.ctx=t,this.setGameWindow(r,o,a),this.init()}return Object.defineProperty(e.prototype,"setGameWindow",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){for(var r=t-2*i,n=r;n%9!=0;)n++;this.gridWidth=n/9,this.gridHeight=r/10,this.startX=(e-n+this.gridWidth)/2,this.startY=(t-r+this.gridHeight)/2,this.endX=this.startX+8*this.gridWidth,this.endY=this.startY+9*this.gridHeight,this.radius=.45*this.gridHeight,this.width=e,this.height=t}}),Object.defineProperty(e.prototype,"setGridDiff",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.gridDiffX="BLACK"===this.gameSide?8:0,this.gridDiffY="BLACK"===this.gameSide?9:0}}),Object.defineProperty(e.prototype,"setGridList",{enumerable:!1,configurable:!0,writable:!0,value:function(){for(var e=0;e<9;e++)for(var t=0;t<10;t++)this.gridPostionList.push(new n(e,t))}}),Object.defineProperty(e.prototype,"getGridPosition",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;return this.gridPostionList.find((function(i){var r=Math.abs(i.x-t.gridDiffX)*t.gridWidth+t.startX,n=Math.abs(i.y-t.gridDiffY)*t.gridHeight+t.startY;return Math.sqrt(Math.pow(r-e.x,2)+Math.pow(n-e.y,2))<t.radius}))}}),Object.defineProperty(e.prototype,"init",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.isMoving=!1,this.currentSide="RED",this.choosePiece=null,this.deadPieceList=[],this.ctx.clearRect(0,0,this.width,this.height),this.drawChessLine()}}),Object.defineProperty(e.prototype,"initPiece",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.livePieceList=function(e){for(var t=[],i=0;i<2;i++){var r=new c({x:0+8*i,y:0,name:"車",radius:e,side:"BLACK",isChoose:!1}),n=new u({x:1+6*i,y:0,name:"馬",radius:e,side:"BLACK",isChoose:!1}),o=new h({x:2+4*i,y:0,name:"象",radius:e,side:"BLACK",isChoose:!1}),s=new l({x:3+2*i,y:0,name:"仕",radius:e,side:"BLACK",isChoose:!1}),a=new v({x:1+6*i,y:2,name:"砲",radius:e,side:"BLACK",isChoose:!1}),d=new c({x:0+8*i,y:9,name:"车",radius:e,side:"RED",isChoose:!1}),y=new u({x:1+6*i,y:9,name:"马",radius:e,side:"RED",isChoose:!1}),g=new h({x:2+4*i,y:9,name:"相",radius:e,side:"RED",isChoose:!1}),p=new l({x:3+2*i,y:9,name:"士",radius:e,side:"RED",isChoose:!1}),m=new v({x:1+6*i,y:7,name:"炮",radius:e,side:"RED",isChoose:!1});t.push(r,n,o,s,a,d,y,g,p,m)}for(i=0;i<5;i++){var x=new b({x:2*i,y:3,name:"卒",radius:e,side:"BLACK",isChoose:!1}),P=new b({x:2*i,y:6,name:"兵",radius:e,side:"RED",isChoose:!1});t.push(x,P)}var w=new f({x:4,y:0,name:"将",radius:e,side:"BLACK",isChoose:!1}),O=new f({x:4,y:9,name:"帅",radius:e,side:"RED",isChoose:!1});return t.push(w,O),t}(this.radius),this.choosePiece=null,this.deadPieceList=[],this.redraw()}}),Object.defineProperty(e.prototype,"drawPeice",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;this.ctx.clearRect(0,0,this.width,this.height),this.drawChessLine(),e.forEach((function(e){return t.drawSinglePeice(e,!0)}))}}),Object.defineProperty(e.prototype,"drawSinglePeice",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this,r=this,n=r.startX,o=r.startY,s=r.gridWidth,a=r.gridHeight,c=r.gridDiffX,u=r.gridDiffY,h="BLACK"===e.side?"#fdec9e":"#feeca0",l="BLACK"===e.side?"#000":"#c1190c",f=e.isChoose?"red":"#000",v=n+e.x*s,b=o+e.y*a;t&&(v=n+Math.abs(e.x-c)*s,b=o+Math.abs(e.y-u)*a);var d=e.radius,y=0;this.ctx.fillStyle=h;var g=function(e,t,r,n,o){i.ctx.beginPath(),i.ctx.arc(e,t,r,n,o),i.ctx.closePath(),i.ctx.stroke()};e.isChoose&&(d/=.98,y="RED"===e.side?-3:3,y=u>0?-1*y:y),this.ctx.beginPath(),this.ctx.arc(v,b+y,d,0,2*Math.PI),this.ctx.shadowOffsetX=3,this.ctx.shadowOffsetY=4,this.ctx.shadowColor="#333",this.ctx.shadowBlur=5,this.ctx.fill(),this.ctx.closePath(),this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.strokeStyle=f,g(v,b+y,d,0,2*Math.PI),g(v,b+y,d-3,0,2*Math.PI),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle=l,this.ctx.font=e.radius+"px yahei",this.ctx.fillText(e.name,v,b+y)}}),Object.defineProperty(e.prototype,"drawChessLine",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,i,n=this,o=n.startX,s=n.startY,a=n.endX,c=n.endY,u=n.gridWidth,h=n.gridHeight;this.ctx.fillStyle="#faebd7",this.ctx.fillRect(0,0,this.width,this.width),this.ctx.strokeStyle="#000";for(var l=0;l<10;l++){this.ctx.beginPath();var f=s+h*l;this.ctx.moveTo(o,f),this.ctx.lineTo(a,f),this.ctx.closePath(),this.ctx.stroke()}for(l=0;l<9;l++){var v=o+l*u,b=s+4*h,d=s+9*h;0!==l&&8!==l?(this.ctx.beginPath(),this.ctx.moveTo(v,s),this.ctx.lineTo(v,b),this.ctx.closePath(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(v,b+h),this.ctx.lineTo(v,c),this.ctx.closePath(),this.ctx.stroke()):(this.ctx.beginPath(),this.ctx.moveTo(v,s),this.ctx.lineTo(v,d),this.ctx.closePath(),this.ctx.stroke())}for(l=0;l<2;l++){var y=(t=2*u,i=2*h,[r({},e={x:v=o+3*u,y:s+7*h*l}),{x:t+e.x,y:e.y},{x:t+e.x,y:e.y+i},{x:e.x,y:e.y+i}]);this.ctx.beginPath(),this.ctx.moveTo(y[0].x,y[0].y),this.ctx.lineTo(y[2].x,y[2].y),this.ctx.moveTo(y[1].x,y[1].y),this.ctx.lineTo(y[3].x,y[3].y),this.ctx.closePath(),this.ctx.stroke()}}}),Object.defineProperty(e.prototype,"activeMove",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i){var n=this,o=i.x-e.x,s=i.y-e.y,a=0===o?0:o/this.moveSpeed,c=0===s?0:s/this.moveSpeed;return"function"==typeof window.requestAnimationFrame&&"function"==typeof window.requestAnimationFrame?new Promise((function(o){var s,u=function(){var h=Math.abs(e.x-i.x),l=Math.abs(e.y-i.y);if(h<=Math.abs(a)&&l<=Math.abs(c)&&n.choosePiece)return window.cancelAnimationFrame(s),o(e);n.drawPeice(t);var f=r({},n.choosePiece);f.x=Math.abs(i.x-n.gridDiffX)-a,f.y=Math.abs(i.y-n.gridDiffY)-c,n.drawSinglePeice(f),i.x-=a,i.y-=c,s=window.requestAnimationFrame(u)};u()})):Promise.resolve(e)}}),Object.defineProperty(e.prototype,"movePeice",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return new Promise((function(r){if(i.choosePiece){var o=i.choosePiece,s=o.x,a=o.y,c=t.filter((function(e){return!(e.x===s&&e.y===a)})),u=new n(i.choosePiece.x,i.choosePiece.y);i.activeMove(e,c,u).then((function(e){i.moveEnd(e),r()}))}else r()}))}}),Object.defineProperty(e.prototype,"clearMoveChoosePeiece",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.choosePiece&&(this.choosePiece=null)}}),Object.defineProperty(e.prototype,"changeSide",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.currentSide="RED"===this.currentSide?"BLACK":"RED"}}),Object.defineProperty(e.prototype,"eatPeice",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(this.choosePiece){var t=this.currentSide,i=y(this.livePieceList,e),r=this.choosePiece;if(this.checkGeneralInTrouble(t,this.choosePiece,{eat:e},this.livePieceList))return void this.moveFailEvents.forEach((function(t){return t(r,e,!0,"不可以送将！")}));this.livePieceList=this.livePieceList.filter((function(t){return!(t.x===e.x&&t.y===e.y)})),this.deadPieceList.push(i),this.isMoving=!0,this.moveStart(r,e,this.livePieceList,t,!0)}}}),Object.defineProperty(e.prototype,"moveStart",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,n,o){var s=this,a="RED"===n?"BLACK":"RED",c=o?{eat:t}:{move:t};this.movePeice(t,i).then((function(){var o=s.checkGeneralInTrouble(a,e,{move:t},i);if(o){var u=i.filter((function(t){return!(t.x===e.x&&t.y===e.y)})),h=d[e.name](r(r({},e),t));if(u.push(h),!s.checkEnemySideInTroubleHasSolution(a,u))return s.gameState="OVER",void s.overEvents.forEach((function(e){return e(n)}))}s.moveEvents.forEach((function(t){return t(e,c,o)}))}))}}),Object.defineProperty(e.prototype,"moveEnd",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;this.livePieceList=this.livePieceList.map((function(i){var n,o;if(i.x===(null===(n=t.choosePiece)||void 0===n?void 0:n.x)&&i.y===(null===(o=t.choosePiece)||void 0===o?void 0:o.y)){var s=r(r(r({},i),{isChoose:!1}),e);return d[i.name](s)}return i})),this.clearMoveChoosePeiece(),this.changeSide(),this.redraw(),this.isMoving=!1}}),Object.defineProperty(e.prototype,"redraw",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.drawPeice(this.livePieceList)}}),Object.defineProperty(e.prototype,"gameStart",{enumerable:!1,configurable:!0,writable:!0,value:function(e){"START"!==this.gameState?(this.gameSide=e,this.init(),this.setGridDiff(),this.initPiece(),this.gameState="START"):this.logEvents.forEach((function(e){return e("刚开始不可以结束")}))}}),Object.defineProperty(e.prototype,"move",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this,i=y(this.livePieceList,e);if(!this.choosePiece){if(!i)return;if(this.currentSide!==i.side)return;return this.choosePiece=i,this.choosePiece.isChoose=!0,this.logEvents.forEach((function(e){return e("当前：".concat(t.currentSide," 方 选中了 棋子:").concat(i))})),void this.redraw()}if(!i){var r=this.choosePiece.move(e,this.livePieceList),n=this.choosePiece;return r.flag?this.checkGeneralInTrouble(this.currentSide,this.choosePiece,{move:e},this.livePieceList)?void this.moveFailEvents.forEach((function(t){return t(n,e,!0,"不可以送将！")})):(this.isMoving=!0,this.moveStart(this.choosePiece,e,this.livePieceList,this.currentSide)):this.moveFailEvents.forEach((function(t){return t(n,e,!0,r.message)}))}if(i.side===this.currentSide)return this.choosePiece===i?(this.choosePiece.isChoose=!1,this.choosePiece=null,this.logEvents.forEach((function(e){return e("我方： 取消选中 "+i)})),this.redraw()):(this.choosePiece.isChoose=!1,this.logEvents.forEach((function(e){return e("我方：切换 选中棋子 由".concat(t.choosePiece," --\x3e ").concat(i))})),this.choosePiece=i,this.choosePiece.isChoose=!0,void this.redraw());this.logEvents.forEach((function(r){return r("当前：".concat(t.currentSide," ,棋子:").concat(t.choosePiece," 需要移动到：").concat(e," 这个点上，并且要吃掉 ").concat(i))}));var o=this.choosePiece.move(e,this.livePieceList);o.flag?this.eatPeice(e):this.moveFailEvents.forEach((function(i){return i(t.choosePiece,e,!1,o.message)}))}}),Object.defineProperty(e.prototype,"moveStr",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;if(this.logEvents.forEach((function(t){return t("当前 ".concat(i.currentSide," 输出：").concat(e))})),this.currentSide===t){var r=function(e,t,i){var r,o,s,a=i.filter((function(e){return e.side===t})),c="RED"===t,u="BLACK"===t?8:0,h="BLACK"===t?9:0,l=c?1:-1;if(j.test(e)&&(o=j.exec(e))){var f=Math.abs(C(o[2])-1-u),v=o[3],b=C(o[4]),d=E("兵",t);if("平"===v&&(b-=1),(P=a.filter((function(e){return e.x===f&&e.name===d}))).length<2)return!1;P.sort((function(e,t){return c?e.y-t.y:t.y-e.y}));var y=P[3===P.length?C(o[1])-1:"前"===o[1]?0:1],m=Math.abs(y.y-h),x=c?m-b*l:m+b*l;if(v===p[0])return{mp:new n(y.x,x),choose:y};if(v===p[1])return{mp:new n(Math.abs(b-u),m),choose:y}}if(w.test(e)&&(r=w.exec(e))){w.lastIndex=0;var P,M=E(r[2],t);if(v=r[3],b=C(r[4]),"平"===v&&(b-=1),(P=a.filter((function(e){return e.name===M}))).length<2)return!1;var L,S=0,A={};P.forEach((function(e){A[e.x]?A[e.x]+=1:A[e.x]=1}));for(var D=Object.keys(A),R=0;R<D.length;R++){var B=A[D[R]];if(S<B)S=B;else if(S===B)return!1}if(L=D[0],(S=A[L])<2)return!1;var T=P.filter((function(e){return String(e.x)===L})),K=r[1];if(K===g[1]&&3!==S)return!1;if(S>=3){if(T.sort((function(e,t){return c?e.y-t.y:t.y-e.y})),y=T[C(K)-1],m=Math.abs(y.y-h),x=c?m-b*l:m+b*l,v===p[0])return{mp:new n(y.x,x),choose:y};if(v===p[1])return{mp:new n(Math.abs(b-u),m),choose:y}}if(2===S&&g.filter((function(e){return"中"!==e})).includes(K)){m=(y=T[K===g[0]?0:1]).y;var k=(q=y.x)-b;if(v===p[0]||v===p[2]){var F=Math.abs(k),X=v===p[2]?-1:1;if("马"===M||"馬"===M){if(F>=1&&F<=2){var Y=1==F;return{choose:y,mp:new n(k<0?Y?q-1*l:q-2*l:Y?q+1*l:q+2*l,Y?m-2*l*X:m-1*l*X)}}return!1}var G=["仕","士"];if(($=["相","象"].includes(M))||G.includes(M)){var I=$?2:1;return(!$||3===F)&&!(!$&&1!==F)&&{choose:y,mp:new n(k>0?q+I*l:q-I*l,m-I*l*X)}}return{choose:y,mp:new n(q,x=m-b*l*X)}}if(v===p[1])return{choose:y,mp:new n(Math.abs(b-u),m)}}return!1}if(O.test(e)&&(s=O.exec(e))){var H=E(s[1],t),W=C(s[2])-1;v=s[3],b=C(s[4]),"平"===v&&(b-=1);var _=Math.abs(W-u);if(!(y=a.find((function(e){return e.x===_&&e.name===H}))))return!1;m=y.y;var q=y.x;if(k=Math.abs(q-u)-b,F=Math.abs(k),v===p[0]||v===p[2]){if(X=v===p[2]?-1:1,"马"===H||"馬"===H){var V=Math.abs(Math.abs(q-u)-(b-1));return V>=1&&V<=2&&(Y=1===V,{choose:y,mp:new n(k+1<0?Y?q+1*l:q+2*l:Y?q-1*l:q-2*l,Y?m-2*l*X:m-1*l*X)})}var $;return G=["仕","士"],($=["相","象"].includes(H))||G.includes(H)?(I=$?2:1,(!$||3===F)&&!(!$&&1!==F)&&{choose:y,mp:new n(k>0?q+I*l:q-I*l,m-I*l*X)}):{choose:y,mp:new n(q,x=m-b*l*X)}}if(v===p[1])return{choose:y,mp:new n(Math.abs(b-u),m)}}return!1}(e,this.currentSide,this.livePieceList);if(r){this.choosePiece&&(this.choosePiece.isChoose=!1,this.choosePiece=null);var o=y(this.livePieceList,r.mp);o&&o.side===this.currentSide?this.logEvents.forEach((function(e){return e("移动的位置有己方棋子")})):(this.choosePiece=r.choose,this.choosePiece.isChoose=!0,this.move(r.mp))}else this.logEvents.forEach((function(e){return e("未找到棋子")}))}else this.logEvents.forEach((function(e){return e("当前为".concat(i.currentSide,"方下棋，请等待！"))}))}}),Object.defineProperty(e.prototype,"gameOver",{enumerable:!1,configurable:!0,writable:!0,value:function(){return"OVER"===this.gameState}}),Object.defineProperty(e.prototype,"checkGeneralInTrouble",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,o){var s,a="BLACK"===e?"RED":"BLACK";if("move"in i){var c=r(r({},t),{x:i.move.x,y:i.move.y}),u=d[c.name](c);(s=o.filter((function(e){return!(e.x===t.x&&e.y===t.y)}))).push(u)}else{c=r(r({},t),{x:i.eat.x,y:i.eat.y}),u=d[c.name](c);(s=o.filter((function(e){return!(e.x===i.eat.x&&e.y===i.eat.y||e.x===t.x&&e.y===t.y)}))).push(u)}if(this.checkGeneralsFaceToFaceInTrouble(s))return!0;var h=s.filter((function(e){return e.side===a})),l=s.find((function(t){return t.side===e&&t instanceof f})),v=new n(l.x,l.y);return h.some((function(e){return e.move(v,s).flag}))}}),Object.defineProperty(e.prototype,"checkGeneralsFaceToFaceInTrouble",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e.filter((function(e){return e instanceof f})).map((function(e){return{x:e.x,y:e.y}})),i=t[0].y>t[1].y?t[0].y:t[1].y,r=t[0].y<t[1].y?t[0].y:t[1].y;return t[0].x===t[1].x&&!e.find((function(e){return e.y<i&&e.y>r&&e.x===t[0].x}))}}),Object.defineProperty(e.prototype,"checkEnemySideInTroubleHasSolution",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this;return t.filter((function(t){return t.side===e})).some((function(r){return r.getMovePoints(t).some((function(n){if(y(t,n.disPoint))return!1;var o=y(t,n)?{eat:n}:{move:n};return!i.checkGeneralInTrouble(e,r,o,t)}))}))}}),Object.defineProperty(e.prototype,"listenClick",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=e.offsetX,i=e.offsetY;if("INIT"!==this.gameState)if("OVER"!==this.gameState)if(this.isMoving)this.logEvents.forEach((function(e){return e("棋子正在移动，无法做任何操作")}));else{var r=this.getGridPosition({x:t,y:i});r&&this.move(r)}else this.logEvents.forEach((function(e){return e("棋盘结束 等待重开！")}));else this.logEvents.forEach((function(e){return e("请选择红黑方")}))}}),Object.defineProperty(e.prototype,"on",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if("function"!=typeof t)throw new Error("监听函数值应该为 function 类型");"log"===e?this.logEvents.push(t):"move"===e?this.moveEvents.push(t):"moveFail"===e?this.moveFailEvents.push(t):"over"===e&&this.overEvents.push(t)}}),Object.defineProperty(e.prototype,"removeEvent",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if("function"!=typeof t)throw new Error("监听函数值应该为 function 类型");"log"===e?this.logEvents=this.logEvents.filter((function(e){return e!==t})):"move"===e?this.moveEvents=this.moveEvents.filter((function(e){return e!==t})):"moveFail"===e?this.moveFailEvents=this.moveFailEvents.filter((function(e){return e!==t})):"over"===e&&(this.overEvents=this.overEvents.filter((function(e){return e!==t})))}}),e}();return e.MovePoint=o,e.Point=n,e.default=M,e.peiceSideMap={RED:"红方",BLACK:"黑方"},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
